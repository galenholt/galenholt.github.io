<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Galen Holt">

<title>Galen Holt - Investigating parallel speedups</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<meta property="og:title" content="Galen Holt - Investigating parallel speedups">
<meta property="og:description" content="I tend to run a lot of code that can be parallelised, but it’s not always clear when it’s worth it and how best to structure the paralellisation.">
<meta property="og:site-name" content="Galen Holt">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Galen Holt</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../code_demos.html" aria-current="page">
 <span class="menu-text">Code Demos</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Investigating parallel speedups</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../code_demos.html" class="sidebar-item-text sidebar-link">Code Demos</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Small how-tos</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/smallpieces.html" class="sidebar-item-text sidebar-link">Bits and pieces</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/quarto_notes.html" class="sidebar-item-text sidebar-link">Quarto notes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup/rstudio_themes.html" class="sidebar-item-text sidebar-link">Editing Rstudio themes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/zip_downloading.html" class="sidebar-item-text sidebar-link">Download and unpack zips</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/json_api_construction.html" class="sidebar-item-text sidebar-link">Building JSON syntax from R for API calls</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/list_names.html" class="sidebar-item-text sidebar-link">Naming rules for lists</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../publishing/private_github_figshare.html" class="sidebar-item-text sidebar-link">Creating Figshare from private github</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/error_handling.html" class="sidebar-item-text sidebar-link">Intro to error handling</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Plotting</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/ggplot_themes.html" class="sidebar-item-text sidebar-link">ggplot themes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/setting_colors_for_groups.html" class="sidebar-item-text sidebar-link">Consistent colors</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/tweaks_tricks.html" class="sidebar-item-text sidebar-link">Saving and themeing plots</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/hcl_exploration.html" class="sidebar-item-text sidebar-link">Exploring HCL colorspace</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/rgb_to_hex.html" class="sidebar-item-text sidebar-link">Converting RGB to hex colors</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/fonts.html" class="sidebar-item-text sidebar-link">Fonts</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/faded_colors.html" class="sidebar-item-text sidebar-link">Faded 2d colour ramps</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/math_in_ggplot.html" class="sidebar-item-text sidebar-link">Latex in ggplot with latex2exp</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Website</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/quarto_website_github.html" class="sidebar-item-text sidebar-link">Getting started</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/updating_website.html" class="sidebar-item-text sidebar-link">Updating and maintaining website</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Theory, simulation, statistics, probability</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simmodelling/twoDautocorr.html" class="sidebar-item-text sidebar-link">Generate 2d autocorrelation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/expected_shannon.html" class="sidebar-item-text sidebar-link">Bootstrapping the expected shannon diversity</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/fitting_lognormals.html" class="sidebar-item-text sidebar-link">Intro to fitting lognormals</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/shifting_normals.html" class="sidebar-item-text sidebar-link">Basic shifts of normal moments</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/fitting_truncated.html" class="sidebar-item-text sidebar-link">Shifting and fitting truncated lognormals</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Drones</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../drones/overlaps_reactive.html" class="sidebar-item-text sidebar-link">Calculations for flight planning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../drones/overlaps.html" class="sidebar-item-text sidebar-link">Figuring out flight plan calcs</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pix4d/read_pix4d_outputs.html" class="sidebar-item-text sidebar-link">Reading and plotting pix4d outputs</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Observable</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../observable/trying_observable.html" class="sidebar-item-text sidebar-link">Figuring out how to use ojs chunks</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">R and python</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_setup.html" class="sidebar-item-text sidebar-link">Python environments with pyenv and poetry</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/py_in_rpkg.html" class="sidebar-item-text sidebar-link">Wrapping python in R package</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/RandPython.html" class="sidebar-item-text sidebar-link">Using R and python together</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/R_py_shared_projects.html" class="sidebar-item-text sidebar-link">Shared R-py project structure</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/py_r_dates.html" class="sidebar-item-text sidebar-link">Passing complex objects py-R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/R_py_type_passing.html" class="sidebar-item-text sidebar-link">Passing types between R and python</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/py_r_project_overview.html" class="sidebar-item-text sidebar-link">Overview of building R-py package</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_nameerror.html" class="sidebar-item-text sidebar-link">Intermittent NameError py-R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_updated_functions.html" class="sidebar-item-text sidebar-link">Small python bits</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">Setting up projects</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/rig.html" class="sidebar-item-text sidebar-link">Managing old R versions with rig</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/managingprivate.html" class="sidebar-item-text sidebar-link">Private data for website repo</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup/R_in_VS.html" class="sidebar-item-text sidebar-link">Using R in VScode</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/end_run_renv.html" class="sidebar-item-text sidebar-link">Dealing with renv failures</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">Building packages</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../package/package_creation.html" class="sidebar-item-text sidebar-link">First pass at building a package</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vicwater/vicwater_testing.html" class="sidebar-item-text sidebar-link">Testing VicWater API</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">Data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/bom_gauges.html" class="sidebar-item-text sidebar-link">BOM gauge locations with httr2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vicwater/vicwater_api_howtocall.html" class="sidebar-item-text sidebar-link">Experimenting with API calls for {vicwater}</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/gauge_data_pre_gauge.html" class="sidebar-item-text sidebar-link">Data from pre-gauged periods</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/ALA_data_pull.html" class="sidebar-item-text sidebar-link">Pulling data from Atlas of Living Australia</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="true">R parallel processing (general)</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/interrogating_parallel.html" class="sidebar-item-text sidebar-link">Interrogating parallel resources</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/nested_parallel.html" class="sidebar-item-text sidebar-link">Testing nested parallelism</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/parallel_speed.html" class="sidebar-item-text sidebar-link active">Speed-testing parallel</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/globals_speed.html" class="sidebar-item-text sidebar-link">Global objects and parallel speed</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/nested_dependent_iterations.html" class="sidebar-item-text sidebar-link">Dependencies of inner parallelism on outer</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="true">R parallel processing on HPC</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/hpc_ephemera.html" class="sidebar-item-text sidebar-link">HPC notes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/plans_and_hpc.html" class="sidebar-item-text sidebar-link">Using single-machine plans on HPC</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/initial_future_batchtools.html" class="sidebar-item-text sidebar-link">Figuring out future.batchtools</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/changing_batchtools_template.html" class="sidebar-item-text sidebar-link">Switching templates, matching to resources</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/template_modification.html" class="sidebar-item-text sidebar-link">Modifying templates</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/master_persistence.html" class="sidebar-item-text sidebar-link">Consequences of master timing out</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/nested_parallel_hpc.html" class="sidebar-item-text sidebar-link">Nested parallel on HPC nodes and cores</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/conditional_plans.html" class="sidebar-item-text sidebar-link">Conditional plans for local and HPC</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#packages-and-setup" id="toc-packages-and-setup" class="nav-link active" data-scroll-target="#packages-and-setup">Packages and setup</a></li>
  <li><a href="#a-data-heavy-loop" id="toc-a-data-heavy-loop" class="nav-link" data-scroll-target="#a-data-heavy-loop">A data-heavy loop</a>
  <ul class="collapse">
  <li><a href="#foreach" id="toc-foreach" class="nav-link" data-scroll-target="#foreach">foreach</a></li>
  <li><a href="#furrr" id="toc-furrr" class="nav-link" data-scroll-target="#furrr">furrr</a></li>
  <li><a href="#future.apply" id="toc-future.apply" class="nav-link" data-scroll-target="#future.apply">future.apply</a></li>
  <li><a href="#simple-for" id="toc-simple-for" class="nav-link" data-scroll-target="#simple-for">simple for</a></li>
  <li><a href="#future-for" id="toc-future-for" class="nav-link" data-scroll-target="#future-for">future for</a></li>
  <li><a href="#linear-algebra" id="toc-linear-algebra" class="nav-link" data-scroll-target="#linear-algebra">linear algebra</a></li>
  </ul></li>
  <li><a href="#test-they-all-work" id="toc-test-they-all-work" class="nav-link" data-scroll-target="#test-they-all-work">Test they all work</a></li>
  <li><a href="#benchmark" id="toc-benchmark" class="nav-link" data-scroll-target="#benchmark">Benchmark</a></li>
  <li><a href="#preallocation-and-lists" id="toc-preallocation-and-lists" class="nav-link" data-scroll-target="#preallocation-and-lists">Preallocation and lists</a>
  <ul class="collapse">
  <li><a href="#preallocate-the-foreach" id="toc-preallocate-the-foreach" class="nav-link" data-scroll-target="#preallocate-the-foreach">preallocate the foreach</a></li>
  <li><a href="#return-the-foreach-as-a-list" id="toc-return-the-foreach-as-a-list" class="nav-link" data-scroll-target="#return-the-foreach-as-a-list">Return the foreach as a list</a></li>
  <li><a href="#dont-preallocate-the-for" id="toc-dont-preallocate-the-for" class="nav-link" data-scroll-target="#dont-preallocate-the-for">Don’t preallocate the for</a></li>
  </ul></li>
  <li><a href="#un-parallelising" id="toc-un-parallelising" class="nav-link" data-scroll-target="#un-parallelising">Un-parallelising</a>
  <ul class="collapse">
  <li><a href="#foreach-do" id="toc-foreach-do" class="nav-link" data-scroll-target="#foreach-do">foreach %do%</a></li>
  <li><a href="#list-foreach-do" id="toc-list-foreach-do" class="nav-link" data-scroll-target="#list-foreach-do">list foreach %do%</a></li>
  <li><a href="#plansequential" id="toc-plansequential" class="nav-link" data-scroll-target="#plansequential">plan(sequential)</a>
  <ul class="collapse">
  <li><a href="#the-message-so-far" id="toc-the-message-so-far" class="nav-link" data-scroll-target="#the-message-so-far">The message so far</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#create-the-data-in-the-function" id="toc-create-the-data-in-the-function" class="nav-link" data-scroll-target="#create-the-data-in-the-function">Create the data in the function</a>
  <ul class="collapse">
  <li><a href="#foreach-1" id="toc-foreach-1" class="nav-link" data-scroll-target="#foreach-1">foreach</a></li>
  <li><a href="#furrrr" id="toc-furrrr" class="nav-link" data-scroll-target="#furrrr">furrrr</a></li>
  <li><a href="#future.apply-1" id="toc-future.apply-1" class="nav-link" data-scroll-target="#future.apply-1">future.apply</a></li>
  <li><a href="#for" id="toc-for" class="nav-link" data-scroll-target="#for">For</a></li>
  <li><a href="#future-for-1" id="toc-future-for-1" class="nav-link" data-scroll-target="#future-for-1">future for</a></li>
  <li><a href="#globals" id="toc-globals" class="nav-link" data-scroll-target="#globals">Globals</a>
  <ul class="collapse">
  <li><a href="#foreach-2" id="toc-foreach-2" class="nav-link" data-scroll-target="#foreach-2">foreach</a></li>
  <li><a href="#furrrr-1" id="toc-furrrr-1" class="nav-link" data-scroll-target="#furrrr-1">furrrr</a></li>
  <li><a href="#future.apply-2" id="toc-future.apply-2" class="nav-link" data-scroll-target="#future.apply-2">future.apply</a></li>
  </ul></li>
  <li><a href="#benchmark-1" id="toc-benchmark-1" class="nav-link" data-scroll-target="#benchmark-1">Benchmark</a></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Investigating parallel speedups</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Galen Holt </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>I tend to run a lot of code that can be parallelised, but it’s not always clear when it’s worth it and how best to structure the paralellisation. Should it be at the outermost layer, where I’m typically looping over parameters, some intermediate layer where I might be looping over indices or iterators, or to handle large datasets?</p>
<p>For reference, I often have population dynamics models with many species and locations. At each timestep I need to make a lot of calculations on the species, including some large matrix multiplications to get dispersal. These could be parallelised over species. And after simulations are complete, I calculate a lot of covariances over species, space, and time that can be parallelised over pairwise combinations. Both of these cases operate on large arrays, and so would feed large amounts of data to parallelised functions, which would then do some limited processing on it (e.g.&nbsp;calculate covariances and clean them up for return). At the other extreme, each of these situations is governed by an initial set of parameters, giving, for example, environmental conditions, species growth rates, etc. These are often just vectors, and so parallelising over them would feed the parallel function small amounts of data and kick off large amounts of work.</p>
<p>To test parallel performance under these different situations, I’ll attempt to build an example that is non-trivial, but still try to stay minimally complex to avoid getting into writing a complex population dynamics model.</p>
<section id="packages-and-setup" class="level2">
<h2 class="anchored" data-anchor-id="packages-and-setup">Packages and setup</h2>
<p>I’ll use the {future} package, along with {dofuture} and {foreach}, because I tend to like writing for loops (there’s a reason- I’ll try to write up sometime later). I’ll also test {furrr} and {future.apply} to see if they differ in any appreciable way.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-1_41c1fffb957dfa7551344542f02d5b86">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: foreach</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: future</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doRNG)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rngtools</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(listenv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just set up a typical doFuture situation with <code>plan(multisession)</code>. Sorting out plans is a topic for another day.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-2_f0f613b5e84419c7d5b0b0585d0f193b">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-data-heavy-loop" class="level1">
<h1>A data-heavy loop</h1>
<p>Let’s just say it’s a biggish (but not obscene) matrix multiplication, which for a single iteration (maybe this is species 1’s dispersal) looks like this:</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-3_4638814e025ff8d026f643ee727c0cff">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">1000</span>), <span class="at">nrow =</span> <span class="dv">1000</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(c <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b, <span class="at">times =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
         expr   min    lq   mean median     uq    max neval
 c &lt;- a %*% b 916.1 919.6 992.32 925.95 1043.6 1205.9    10</code></pre>
</div>
</div>
<p>Now, let’s say we have a lot of species- ie there are 100 <code>a</code>’s in the situation above. I’ll put them in a list so I can use <code>foreach</code> or <code>furrr</code> or <code>future.apply</code> might make the most sense. My code often makes the most sense in loops because of dependencies and so I tend to keep writing them, but anything parallelisable should be able to be coerced into working with <code>furrr</code> or <code>future.apply.</code></p>
<p>So, let’s say I have 100 ‘species’ that each get multiplied by the b above</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-4_0a7798475877fb0c024d506b4f5e85ba">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>a100 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">100</span><span class="sc">*</span><span class="dv">1000</span>), <span class="at">ncol =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In a single- case, this is</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-5_4e3b5332adcc0646d4569b2764b55682">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> a100[,<span class="dv">1</span>] <span class="sc">%*%</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So what we want to do is multiply each column of a100 by b and then glue them back together. And yes, we could do all this more cleanly with linear algebra. The point here is to test the situation where we have a reasonably large amount of data we want to iterate over and do some smallish number of operations on. I’ll make each one a function so we can easily run them through <code>microbenchmark</code> (and later, nest them).</p>
<section id="foreach" class="level2">
<h2 class="anchored" data-anchor-id="foreach">foreach</h2>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-6_31e7ed382c3aef889e37f1cdc7bd720d">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mult_foreach <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a), <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_foreach))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="furrr" class="level2">
<h2 class="anchored" data-anchor-id="furrr">furrr</h2>
<p><code>purrr</code> (and so <code>furrr</code>) don’t seem to work on matrices. So, I guess have a silly pre-step to make it a list. I’m going to do that outside the function, simply because if we went this way, we’d set the data up to work.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-7_ab6969e913647f834ba1e444fadcfe29">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mult_furrr <span class="ot">&lt;-</span> <span class="cf">function</span>(a_list, b) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  c_map <span class="ot">&lt;-</span> <span class="fu">future_map</span>(a_list, \(x) x <span class="sc">%*%</span> b)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_map), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future.apply" class="level2">
<h2 class="anchored" data-anchor-id="future.apply">future.apply</h2>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-8_9602c2b034207fc8ef715dff90a962eb">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mult_apply <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">future_apply</span>(a, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">%*%</span> b)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-for" class="level2">
<h2 class="anchored" data-anchor-id="simple-for">simple for</h2>
<p>Preallocate, because I’m not a heathen</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-9_0f15b188f2cbd88706ba82012cb08b74">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mult_for <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> a</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    c_for[,i] <span class="ot">&lt;-</span> a[,i] <span class="sc">%*%</span> b</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_for)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future-for" class="level2">
<h2 class="anchored" data-anchor-id="future-for">future for</h2>
<p>We can write a usual for loop if we use futures directly. the futures themselves have to go in a list, because they are futures, not values, and so can’t go straight into a matrix. That list <em>can</em> be preallocated.</p>
<p>There are two ways to do this- explicit and implicit- <a href="https://github.com/HenrikBengtsson/future">see the future docs</a>.</p>
<section id="explicit-futures" class="level4">
<h4 class="anchored" data-anchor-id="explicit-futures">Explicit futures</h4>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-10_c25d7f1aa1fe054e258b9f5ba5f39689">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_e <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">'list'</span>, <span class="at">length =</span> <span class="fu">ncol</span>(a))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="ot">&lt;-</span> <span class="fu">future</span>({a[,i] <span class="sc">%*%</span> b})</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">lapply</span>(c_for, <span class="at">FUN =</span> value)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> <span class="fu">ncol</span>(a)))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implicit-futures" class="level4">
<h4 class="anchored" data-anchor-id="implicit-futures">Implicit futures</h4>
<p>using <code>listenv</code></p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-11_52e0e89bc599bde3899d31966243d61e">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_i <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">listenv</span>()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="sc">%&lt;-%</span> {a[,i] <span class="sc">%*%</span> b}</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">as.list</span>(c_for)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> <span class="fu">ncol</span>(a)))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="linear-algebra" class="level2">
<h2 class="anchored" data-anchor-id="linear-algebra">linear algebra</h2>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-12_a27ccc1c1dd15738602940bb76eb3c61">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>mult_linear <span class="ot">&lt;-</span> <span class="cf">function</span>(a,b) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="test-they-all-work" class="level1">
<h1>Test they all work</h1>
<p>set up a small test case and see if they are all returning the same answer</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-13_63a03b6af1b16b568f94d81381b2a986">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>asmall <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">2</span>), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>asmall_l <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">as.data.frame</span>(asmall)) <span class="co"># This is silly</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>bsmall <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">10</span>), <span class="at">ncol =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-14_3db460a8d4312d8e3fd0d6cb232580bc">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>c_foreach <span class="ot">&lt;-</span> <span class="fu">mult_foreach</span>(asmall, bsmall)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>c_furrr <span class="ot">&lt;-</span> <span class="fu">mult_furrr</span>(asmall_l, bsmall)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>c_apply <span class="ot">&lt;-</span> <span class="fu">mult_apply</span>(asmall, bsmall)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>c_for <span class="ot">&lt;-</span> <span class="fu">mult_for</span>(asmall, bsmall)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>c_for_fe <span class="ot">&lt;-</span> <span class="fu">mult_for_future_e</span>(asmall, bsmall)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>c_for_fi <span class="ot">&lt;-</span> <span class="fu">mult_for_future_i</span>(asmall, bsmall)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>c_linear <span class="ot">&lt;-</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(asmall), bsmall)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-15_08766b2d96646420948069ddccd84d38">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_furrr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_apply)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_for)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_for_fe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_for_fi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_linear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="benchmark" class="level1">
<h1>Benchmark</h1>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-16_e3d254351bb1e212e9c4246f4729f8da">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>a100_l <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">as.data.frame</span>(a100))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr</span>(a100_l, b),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply</span>(a100, b),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">future_for_e =</span> <span class="fu">mult_for_future_e</span>(a100, b),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">future_for_i =</span> <span class="fu">mult_for_future_i</span>(a100, b),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
          expr       min        lq       mean     median        uq       max
 futureforeach  246.5164  261.0851  440.42224  275.53895  299.7969 1477.3723
   futurefurrr  426.9049  451.7943  789.56338  564.39905  853.5767 2317.1858
   futureapply  593.2429  596.0820  673.34245  630.26995  655.8609 1113.3054
      bare_for   88.6881   90.0731  100.39437   94.16920  106.8242  134.1617
  future_for_e 2786.3775 2806.7822 2829.48139 2829.34415 2843.8799 2893.0394
  future_for_i 2800.1442 2822.3532 2851.98505 2843.66680 2900.2428 2910.3389
   bare_linear   34.8542   35.6356   41.39234   36.94765   52.0295   54.9435
 neval
    10
    10
    10
    10
    10
    10
    10</code></pre>
</div>
</div>
<p>Well, that’s interesting. The futures are hugely slower than even the bare <code>for</code>. And the direct futures in a <code>for</code> are the worst by far (so bad there must be something major wrong). Is it just overhead passing the matrices to workers? That might explain the poor performance of the direct futures in <code>for</code>- if the other <code>future</code> functions chunk to avoid passing everything every time, then the overhead hits the direct versions much harder. Or something else? Does preallocating help for the foreach, apply, etc?</p>
</section>
<section id="preallocation-and-lists" class="level1">
<h1>Preallocation and lists</h1>
<p>This is a bit of an aside- we <em>know</em> preallocation speeds up <code>for</code> loops. Does it speed up <code>foreach</code>? Seems unlikely, since by nature <code>foreach</code> constructs the object additively as a list or whatever’s specified in <code>.combine</code>. That can make the code cleaner in a lot of cases if we’re building something in a loop, but it seems more like the un-preallocated <code>for</code> method of doing things.</p>
<p>Let’s test and see.</p>
<section id="preallocate-the-foreach" class="level2">
<h2 class="anchored" data-anchor-id="preallocate-the-foreach">preallocate the foreach</h2>
<p>I typically don’t do this, since my understanding of foreach is that it builds them with the .combine, so preallocating doesn’t do anything. But maybe?</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-17_51d728ff563e9bfc1dcbb3def0a8d446">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_pre <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">t</span>(a)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a), <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_foreach))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="return-the-foreach-as-a-list" class="level2">
<h2 class="anchored" data-anchor-id="return-the-foreach-as-a-list">Return the foreach as a list</h2>
<p>It is possible that using <code>.combine</code> is forcing slower behaviour for the foreach, and it’s optimized for a list?</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-18_94ac141927c87de14a3d8efe668785bd">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_list <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) <span class="sc">%dopar%</span> {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do the binding in one step</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(c_foreach), <span class="at">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dont-preallocate-the-for" class="level2">
<h2 class="anchored" data-anchor-id="dont-preallocate-the-for">Don’t preallocate the for</h2>
<p>How bad is this- I almost always DO preallocate (it’s faster, and the loop starts at 1, and it’s just cleaner), but it’s possible not to.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-19_32abe03f1d458528571855d76bb76c63">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mult_for_build <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> a[,<span class="dv">1</span>] <span class="sc">%*%</span> b</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    ctemp <span class="ot">&lt;-</span> a[,i] <span class="sc">%*%</span> b</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    c_for <span class="ot">&lt;-</span> <span class="fu">rbind</span>(c_for, ctemp)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_for))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll include the <code>furrr</code> and <code>future.apply</code> here too, I guess as reference.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-20_52b84e033610a9dc39057c3a34db99eb">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr</span>(a100_l, b),</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply</span>(a100, b),</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">preallocate_foreach =</span> <span class="fu">mult_foreach_pre</span>(a100, b),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">foreach_list =</span> <span class="fu">mult_foreach_list</span>(a100, b),</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">unallocate_for =</span> <span class="fu">mult_for_build</span>(a100, b),</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                expr      min       lq     mean    median       uq      max
         futurefurrr 443.6282 486.7204 514.9555 499.42955 508.2764 724.0422
         futureapply 587.7048 634.2925 673.7851 647.22095 740.1291 767.1812
       futureforeach 244.3625 253.6442 321.1252 256.70470 287.4974 804.0015
 preallocate_foreach 242.1381 251.5804 278.5400 277.79885 282.3750 374.8727
        foreach_list 248.4650 272.0348 290.8289 299.22400 306.9559 343.0977
            bare_for  88.4069  89.8161 100.2756  93.38755 103.5877 133.0030
      unallocate_for 106.7770 111.9356 119.9050 119.36350 129.2688 134.1177
         bare_linear  35.4130  38.0087  42.1330  39.99825  43.7534  58.0615
 neval
    10
    10
    10
    10
    10
    10
    10
    10</code></pre>
</div>
</div>
<p>These results are interesting, and the actual <em>slowdown</em> (not just lack of speedup) is worrying for how I do some things. I think the overhead of shifting the data around is absolutely killing these parallel processes. And I definitely have code that does this sort of thing.</p>
<p>I have two more questions now (plus one for later):</p>
<ol type="1">
<li><p>Does the <code>foreach</code> loop work as fast as a <code>for</code> if I use <code>%do%</code> instead of <code>%dopar%</code>? Or is the overhead still there?</p>
<ol type="1">
<li>And same with all the futures if I set <code>plan(sequential)</code>?</li>
</ol></li>
<li><p>If I don’t send prebuilt data, but just some parameters and build the data internally, how do they compare?</p>
<ol type="1">
<li>Sometimes this flow makes sense, and sometimes it doesn’t– e.g.&nbsp;if I’m simulating populations, the outer set of parallelisation just sends parameters. But the internal set often needs to work on things like population matrices. And so maybe that internal loop just shouldn’t be parallel.</li>
</ol></li>
<li><p>How do other <code>plan</code> options affect these answers? I think this deserves its own page, and could get very complicated once I get into <code>future.callr</code>, <code>future.batchtools</code>, <code>cluster</code>, etc. And <code>multicore</code> might avoid the passing and use pointers, but i can’t test on windows?</p></li>
</ol>
</section>
</section>
<section id="un-parallelising" class="level1">
<h1>Un-parallelising</h1>
<section id="foreach-do" class="level2">
<h2 class="anchored" data-anchor-id="foreach-do">foreach %do%</h2>
<p>Let’s try shifting to <code>%do%</code> for the foreach</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-21_7c9a5499f1d15ebcc457ee0daab94f48">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_do <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a), <span class="at">.combine =</span> rbind) <span class="sc">%do%</span> {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_foreach))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="list-foreach-do" class="level2">
<h2 class="anchored" data-anchor-id="list-foreach-do">list foreach %do%</h2>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-22_dd0e937d266d9108f1bb8668fc89f0ab">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_list_do <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) <span class="sc">%do%</span> {</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do the binding in one step</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(c_foreach), <span class="at">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test against parallel foreach, bare for, and the unallocated for (since that’s kind of what the foreach is doing- building up an object). Since that’s sometimes nice behaviour and leads to cleaner code than a for loop, I’d like to see how they compare.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-23_5a6193123914272cb8a7acf506e56551">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">foreachdo =</span> <span class="fu">mult_foreach_do</span>(a100, b),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">foreachlistdo =</span> <span class="fu">mult_foreach_list_do</span>(a100, b),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">unallocate_for =</span> <span class="fu">mult_for_build</span>(a100, b),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
           expr      min       lq      mean   median       uq      max neval
  futureforeach 235.1256 243.4750 264.39874 258.7047 280.2599 321.3101    10
      foreachdo  94.8164  97.6870 100.78289 100.6124 102.1715 107.7091    10
  foreachlistdo  96.9755  98.4346 100.76391 101.1035 103.3189 105.4224    10
       bare_for  86.3208  87.9507  88.75037  88.3432  89.2126  92.0338    10
 unallocate_for 104.1609 108.6303 110.51359 109.9748 112.3416 116.5181    10
    bare_linear  35.3966  36.1527  37.14453  36.3332  37.2698  42.9894    10</code></pre>
</div>
</div>
<p>Interesting. Nearly identical to the unallocated for and quite a bit <em>faster</em> than the parallel version, which seems to hint that it’s the data transfer that’s killing things. And backs up my assumption of what’s going on under the hood in terms of constructing the object as in an unallocated for loop. There’s no appreciable difference in using the foreach with a list and then combining vs combining as we go with <code>.combine</code>.</p>
</section>
<section id="plansequential" class="level2">
<h2 class="anchored" data-anchor-id="plansequential">plan(sequential)</h2>
<p>How do the parallel versions work with <code>plan(sequential)</code>? Do they all get a speedup from avoiding data transfer? This is the same benchmark test as above, but now run sequentially.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-24_2b93800683ab255dc330ffcd3799a00a">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(sequential)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr</span>(a100_l, b),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply</span>(a100, b),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">unallocate_for =</span> <span class="fu">mult_for_build</span>(a100, b),</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'purrr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:listenv':

    map</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:foreach':

    accumulate, when</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
           expr      min       lq      mean   median       uq      max neval
    futurefurrr 110.2440 114.4588 119.01770 118.1613 121.6648 136.4901    10
    futureapply 327.7384 328.5536 332.10152 329.8668 336.5330 341.8481    10
  futureforeach 106.6627 107.0847 110.10954 109.0071 109.9754 120.1479    10
       bare_for  86.4083  87.0670  88.07185  87.3572  88.7584  91.1030    10
 unallocate_for 109.3728 109.9509 113.80280 113.8166 116.2439 121.0449    10
    bare_linear  35.3039  35.7138  37.46994  36.4234  38.2815  43.2047    10</code></pre>
</div>
</div>
<p>Interesting. <code>foreach</code> and <code>furrr</code> both sped up about as expected (<code>furrr</code> just seems a bit slower in general), but <code>future.apply</code> had much less of a speedup. It must not fall back to a simpler function, and still tries to use the parallel data shuffling? It is still much faster than with <code>plan(multisession)</code> (was 590 microseconds), so something is happening, but it’s not getting down to the speeds of the other futures. And the simple <code>for</code> is still fastest (other than just using linear algebra, obviously).</p>
<section id="the-message-so-far" class="level3">
<h3 class="anchored" data-anchor-id="the-message-so-far">The message so far</h3>
<p>Test the parallel implementation at different points in the code- if there’s no way to avoid data passing, a simple <code>for</code> (or other sequential function like <code>apply</code> could be fastest.</p>
</section>
</section>
</section>
<section id="create-the-data-in-the-function" class="level1">
<h1>Create the data in the function</h1>
<p>Sometimes it does work (or makes more sense) to create the data inside each parallel process. This is certainly the case where we’re looping over parameter sets for simulations, which tend to be embarassingly parallel and low-data, which then sets of lots of processing. It’s <em>also</em> likely to be the case in another situation I encounter often- reading chunks of large raster data, where I can keep it as <code>stars_proxy</code> objects until inside a parallel loop, where I can bring a chunk into memory. Something similar is likely true of things like netcdf reading.</p>
<p>To test this sort of situation, let’s use the same functions as above, but now create the vectors and matrices internally, rather than pass them in. I’m going to remake the <code>b</code> matrix internally because the point is to check this use of parallelism (lots of processing triggered from small data), even though in practice for this particular sort of calculation we’d need to pass it in so it’s common to all the a’s. Here, it’s just a stand-in for “do some work”. Let’s make the first argument actually do something other than just replicate, so have it set the mean of <code>a</code>.</p>
<p>I’m not going to bother with setting seeds because it’ll be a pain to get them to match across the different ways of doing this, so the answers will be different.</p>
<p>Do we need to adjust globals here? If we leave defaults, we copy in the whole parent environment, right? and so don’t end-run anything? e.g.&nbsp;<code>.options = furrr_options(globals = "y")</code> for <code>furrr</code>? No, see tests of this below- <code>future</code> only passes in the needed objects from global.</p>
<p>Turn parallel processing back on.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-25_cd6e14d40b51c6021d8e53885db90d35">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="foreach-1" class="level3">
<h3 class="anchored" data-anchor-id="foreach-1">foreach</h3>
<p>changing this a bit too so <em>all</em> the work is done inside (no <code>t</code> on the return)</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-26_49459b836efaaf1654745ff3e92881f3">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n_reps, <span class="at">.combine =</span> cbind) <span class="sc">%dorng%</span> {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_foreach)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="furrrr" class="level3">
<h3 class="anchored" data-anchor-id="furrrr">furrrr</h3>
<p>reframing this one too, because <code>future_map</code> needs to call the function that does all the generating. This construction gets contrived very quickly.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-27_10fde98c1efe5a5d0451a72f96940930">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mult_furrr_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  c_map <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, fn_to_call, <span class="at">size =</span> size, <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_map), <span class="at">ncol =</span> n_reps)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future.apply-1" class="level3">
<h3 class="anchored" data-anchor-id="future.apply-1">future.apply</h3>
<p>modifying to <code>future_lapply</code> because it doesn’t make sense to <code>apply</code> over the margins of a matrix that gets created. Again, this is getting contrived.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-28_397a2f2e44d524723bba9f9e8f568b4a">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>mult_apply_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  c_apply <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, <span class="at">FUN =</span> fn_to_call, size, <span class="at">future.seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_apply), <span class="at">ncol =</span> n_reps)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="for" class="level3">
<h3 class="anchored" data-anchor-id="for">For</h3>
<p>back to preallocating- we know it’s better</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-29_c850d84d1b547faa5299b7984685d5af">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>mult_for_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> size, <span class="at">ncol =</span> n_reps)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps) {</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        c_for[,i] <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_for)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future-for-1" class="level2">
<h2 class="anchored" data-anchor-id="future-for-1">future for</h2>
<p>We can write a usual for loop if we use futures directly. the futures themselves have to go in a list, because they are futures, not values, and so can’t go straight into a matrix. That list <em>can</em> be preallocated.</p>
<p>There are two ways to do this- explicit and implicit- <a href="https://github.com/HenrikBengtsson/future">see the future docs</a>.</p>
<section id="explicit-futures-1" class="level4">
<h4 class="anchored" data-anchor-id="explicit-futures-1">Explicit futures</h4>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-30_f819227fb9af8868e5857422bf8089bd">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_internal_e <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">'list'</span>, <span class="at">length =</span> n_reps)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps) {</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="ot">&lt;-</span> <span class="fu">future</span>({a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">%*%</span> b}, <span class="at">seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">lapply</span>(c_for, <span class="at">FUN =</span> value)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> n_reps))</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implicit-futures-1" class="level4">
<h4 class="anchored" data-anchor-id="implicit-futures-1">Implicit futures</h4>
<p>using <code>listenv</code></p>
<p>That’s a funny way to set the seed. Good to know.</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-31_bcd8c458e8edecf1b553d0e115e7eda9">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_internal_i <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">listenv</span>()</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps) {</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="sc">%&lt;-%</span> {a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">%*%</span> b} <span class="sc">%seed%</span> <span class="cn">TRUE</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">as.list</span>(c_for)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> n_reps))</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There’s no reason to have a linear algebra version here, since we’re by definition not operating on existing matrices.</p>
<p>Try that <em>without</em> adjusting what globals are passed to the futures</p>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-32_3bfb97019946f395abf8731e33091b4c">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefor_e =</span> <span class="fu">mult_for_future_internal_e</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefor_i =</span> <span class="fu">mult_for_future_internal_i</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
          expr       min        lq      mean    median        uq       max
   futurefurrr  638.0028  658.8124  868.5756  663.1727  673.2477 2710.5420
   futureapply  647.0352  653.3856  779.9339  660.3188  669.0498 1852.4155
 futureforeach  637.7363  644.3180  670.8410  655.9570  677.6647  776.2754
   futurefor_e 2639.2926 2669.8748 2688.2644 2682.2723 2702.9564 2751.7045
   futurefor_i 2658.7272 2668.5496 2721.6388 2720.5006 2738.6566 2825.9734
      bare_for 3137.0728 3160.3969 3193.4383 3182.6047 3211.6341 3323.5784
 neval
    10
    10
    10
    10
    10
    10</code></pre>
</div>
</div>
<p>Now the parallelisation <em>is</em> helping quite a bit, even the <code>for</code> loops with futures, though they’re still much slower than the other <code>future</code> methods. However, this is much slower than creating the matrices as we actually should do for this particular calculation, and is even slower than passing those matrices in. So, if the operations need to happen this way anyway (parallel lots of stuff over parameters), this makes lots of sense and speeds up. If we CAN pre-generate matrices, linear algebra is fastest (unsurprisingly), and the loops are next, even if we have to eat pass-in cost. Though in that case sequential is probably better.</p>
<p>I think the slower bare futures are likely because there’s no chunking being done, and so data is copied to <em>each</em> iteration, rather than to chunks of iterations (which is built into <code>doFuture</code> and I think <code>furrr</code> and <code>future.apply</code>. I could try to manually chunk to test that, but I think I’m just going to skip it.</p>
</section>
</section>
<section id="globals" class="level2">
<h2 class="anchored" data-anchor-id="globals">Globals</h2>
<p>One of the nice things about <code>future</code> compared to some other parallel backends is that it does pass the global environment, so i don’t have to manage what it gets- it works as it does interactively. BUT, if data passing is what’s killing the speed, maybe I <em>do</em> need to manage what gets passed. In theory, the test above should get even faster if we don’t pass it the global environment, but <em>only</em> the arguments.</p>
<p>So, a new version of the above, explicitly limiting passing.</p>
<section id="foreach-2" class="level3">
<h3 class="anchored" data-anchor-id="foreach-2">foreach</h3>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-33_15cd08d2ccb76d613475c8fe939e9358">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_internal_g <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n_reps, </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> cbind,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.export =</span> <span class="cn">NULL</span>) <span class="sc">%dorng%</span> {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_foreach)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="furrrr-1" class="level3">
<h3 class="anchored" data-anchor-id="furrrr-1">furrrr</h3>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-34_b1f29c99872f58c567d805c940d7c09f">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>mult_furrr_internal_g <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  c_map <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, fn_to_call, <span class="at">size =</span> size, </span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>, <span class="at">globals =</span> <span class="cn">NULL</span>))</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_map), <span class="at">ncol =</span> n_reps)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future.apply-2" class="level3">
<h3 class="anchored" data-anchor-id="future.apply-2">future.apply</h3>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-35_3d8d6fc62da495501f6e02d64a82302d">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>mult_apply_internal_g <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  c_apply <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, <span class="at">FUN =</span> fn_to_call, size, </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">future.seed =</span> <span class="cn">TRUE</span>, <span class="at">future.globals =</span> <span class="cn">FALSE</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_apply), <span class="at">ncol =</span> n_reps)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="benchmark-1" class="level2">
<h2 class="anchored" data-anchor-id="benchmark-1">Benchmark</h2>
<div class="cell" data-hash="parallel_speed_cache/html/unnamed-chunk-36_f582c5800b865ce04ca859499f6de936">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr_g =</span> <span class="fu">mult_furrr_internal_g</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply_g =</span> <span class="fu">mult_apply_internal_g</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach_g =</span> <span class="fu">mult_foreach_internal_g</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
            expr       min        lq      mean    median        uq       max
     futurefurrr  650.9615  655.6274  667.7335  665.4363  672.8008  695.4913
     futureapply  660.9141  681.4908  691.7151  685.7910  705.6650  735.2728
   futureforeach  643.2652  665.4859  671.3939  670.2467  672.7690  700.9367
   futurefurrr_g  670.0894  676.9485  690.0467  684.3684  695.3350  723.5180
   futureapply_g  658.1669  669.3657  675.3438  671.9081  682.6484  695.2184
 futureforeach_g  641.1861  654.8838  679.7260  666.7028  705.6335  748.3529
        bare_for 3191.5845 3219.5277 3261.9446 3256.3190 3309.1928 3349.3968
 neval
    10
    10
    10
    10
    10
    10
    10</code></pre>
</div>
</div>
<p>So, that’s not hauling around a ton of extra stuff. I think, based on <a href="https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html">the doFuture vignette</a>, that <code>future</code> will send the globals, but only those that are needed. So it’s not that they’re in functions, it’s that <code>future</code> can tell it doesn’t need to pass extra variables. This means we don’t really get performance gains because <code>future</code> already had our back.</p>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<ul>
<li><p>If we can just write good linear algebra, that’s best. No surprise there. But sometimes we can’t.</p></li>
<li><p>If we have large amounts of data, it’s likely fastest to use a preallocated <code>for</code> loop or <code>apply</code> or <code>purrr::map</code> other sequential operation.</p>
<ul>
<li>Even if we <em>have</em> to parallelise and take a performance hit (why? who knows? maybe because it’s buried in a function that needs the ability to be parallel if it’s the outer function?), passing in existing data is still faster than generating the data inside (over what range of data sizes?). But sometimes we need to generate the data inside anyway. In which case-</li>
</ul></li>
<li><p>If we have a bunch of work to do, based on small amounts of data (e.g.&nbsp;parameters, iterators), then the parallel futures are best, without much difference between the flavours.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>