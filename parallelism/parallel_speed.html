<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Galen Holt">

<title>Investigating parallel speedups – Galen Holt</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<meta property="og:title" content="Investigating parallel speedups – Galen Holt">
<meta property="og:description" content="">
<meta property="og:site_name" content="Galen Holt">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Galen Holt</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../code_demos.html" aria-current="page"> 
<span class="menu-text">Code Demos</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/galenholt"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com.au/citations?user=f94WBOoAAAAJ&amp;hl=en"> <i class="bi bi-mortarboard-fill" role="img" aria-label="Google Scholar">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/galen-holt-265aa290"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fediscience.org/@galen_holt"> <i class="bi bi-mastodon" role="img" aria-label="Mastodon">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../parallelism/interrogating_parallel.html">R parallel processing (general)</a></li><li class="breadcrumb-item"><a href="../parallelism/parallel_speed.html">Speed-testing parallel</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../code_demos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Code Demos</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Small how-tos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/smallpieces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bits and pieces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/quarto_notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup/rstudio_themes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Editing Rstudio themes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/zip_downloading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Download and unpack zips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/json_api_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building JSON syntax from R for API calls</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/list_names.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Naming rules for lists</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../publishing/private_github_figshare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Creating Figshare from private github</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/error_handling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to error handling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/error_safely.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>Safe</code> error passing in loops</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/lifecycle_warnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intermittent lifecycle warnings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/dplyr_filter_matrix_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dplyr filter matrices</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/private_github_notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dealing with private github</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/renv_github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installing from github with renv</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/breaking_whiles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">While loops, break, and debugging</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Plotting</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/ggplot_themes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot themes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/setting_colors_for_groups.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Consistent colors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/tweaks_tricks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Saving and themeing plots</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/hcl_exploration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploring HCL colorspace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/rgb_to_hex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Converting RGB to hex colors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/fonts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fonts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/faded_colors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Faded 2d colour ramps</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/math_in_ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Latex in ggplot with latex2exp</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/rayshader.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3d plotting with rayshader</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/legend_in_facet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Legends in empty facets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../plotting/venn_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Venn diagrams in ggplot2</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Quarto</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/quarto_website_github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/updating_website.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Updating and maintaining website</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/quarto_change_yml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Avoiding rendering whole site for testing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/quarto_images_misc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Figures in quarto</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/render_word.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rendering to word</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/render_pdf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rendering to pdf</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/multiple_render_formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rendering multiple formats (and serving from web)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/commenting_quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Adding comments to html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../website_notes/quarto_profiles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto profiles for incremental render</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Theory, simulation, statistics, probability</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simmodelling/twoDautocorr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generate 2d autocorrelation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/spatial_ac.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regressions with spatial autocorrelation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/expected_shannon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bootstrapping the expected shannon diversity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/fitting_lognormals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to fitting lognormals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/shifting_normals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic shifts of normal moments</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stats_probability/fitting_truncated.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shifting and fitting truncated lognormals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../betabinomial/betadists.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick look at beta pdfs</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Drones</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../drones/overlaps_reactive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculations for flight planning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../drones/overlaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Figuring out flight plan calcs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pix4d/read_pix4d_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reading and plotting pix4d outputs</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Observable</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../observable/trying_observable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Figuring out how to use ojs chunks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">R and python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python environments with pyenv and poetry</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/py_in_rpkg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wrapping python in R package</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/RandPython.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using R and python together</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/R_py_shared_projects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shared R-py project structure</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/py_r_dates.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Passing complex objects py-R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/R_py_type_passing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Passing types between R and python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/py_r_project_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview of building R-py package</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_nameerror.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intermittent NameError py-R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_updated_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Small python bits</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/python_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing python</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true">
 <span class="menu-text">Setting up projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/rig.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Managing old R versions with rig</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/managingprivate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Private data for website repo</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup/R_in_VS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using R in VScode</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../RpyEnvs/end_run_renv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dealing with renv failures</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true">
 <span class="menu-text">Building packages</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../package/package_creation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">First pass at building a package</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../package/indexing_version.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatically indexing package versions with git</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tidyprogramming/tidy_programs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Programming with dplyr and rlang</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../hydrogauge/hydrogauge_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing hydrogauge API</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/failing_snapshot_check.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Snapshot failures on check</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../small_helpers/vdiffr_networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing network plots with vdiffr</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="true">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/bom_gauges.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BOM gauge locations with httr2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../hydrogauge/hydrogauge_api_howtocall.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Experimenting with API calls for {hydrogauge}</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/bom_water.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Experimenting with API calls from BOM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/gauge_data_pre_gauge.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data from pre-gauged periods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/ALA_data_pull.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pulling data from Atlas of Living Australia</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/get_geofabric.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Downloading Australian rivers geofabric</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_acquisition/read_geofabric.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using Australian rivers geofabric</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="true">
 <span class="menu-text">R parallel processing (general)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/interrogating_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interrogating parallel resources</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/nested_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing nested parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/parallel_speed.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Speed-testing parallel</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/globals_speed.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Global objects and parallel speed</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/nested_dependent_iterations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dependencies of inner parallelism on outer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="true">
 <span class="menu-text">R parallel processing on HPC</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/hpc_ephemera.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HPC notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/plans_and_hpc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using single-machine plans on HPC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/initial_future_batchtools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Figuring out future.batchtools</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/changing_batchtools_template.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Switching templates, matching to resources</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/template_modification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modifying templates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/master_persistence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Consequences of master timing out</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/nested_parallel_hpc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nested parallel on HPC nodes and cores</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parallelism/conditional_plans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditional plans for local and HPC</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#packages-and-setup" id="toc-packages-and-setup" class="nav-link active" data-scroll-target="#packages-and-setup">Packages and setup</a></li>
  <li><a href="#a-data-heavy-loop" id="toc-a-data-heavy-loop" class="nav-link" data-scroll-target="#a-data-heavy-loop">A data-heavy loop</a>
  <ul class="collapse">
  <li><a href="#foreach" id="toc-foreach" class="nav-link" data-scroll-target="#foreach">foreach</a></li>
  <li><a href="#furrr" id="toc-furrr" class="nav-link" data-scroll-target="#furrr">furrr</a></li>
  <li><a href="#future.apply" id="toc-future.apply" class="nav-link" data-scroll-target="#future.apply">future.apply</a></li>
  <li><a href="#simple-for" id="toc-simple-for" class="nav-link" data-scroll-target="#simple-for">simple for</a></li>
  <li><a href="#future-for" id="toc-future-for" class="nav-link" data-scroll-target="#future-for">future for</a></li>
  <li><a href="#linear-algebra" id="toc-linear-algebra" class="nav-link" data-scroll-target="#linear-algebra">linear algebra</a></li>
  </ul></li>
  <li><a href="#test-they-all-work" id="toc-test-they-all-work" class="nav-link" data-scroll-target="#test-they-all-work">Test they all work</a></li>
  <li><a href="#benchmark" id="toc-benchmark" class="nav-link" data-scroll-target="#benchmark">Benchmark</a></li>
  <li><a href="#preallocation-and-lists" id="toc-preallocation-and-lists" class="nav-link" data-scroll-target="#preallocation-and-lists">Preallocation and lists</a>
  <ul class="collapse">
  <li><a href="#preallocate-the-foreach" id="toc-preallocate-the-foreach" class="nav-link" data-scroll-target="#preallocate-the-foreach">preallocate the foreach</a></li>
  <li><a href="#return-the-foreach-as-a-list" id="toc-return-the-foreach-as-a-list" class="nav-link" data-scroll-target="#return-the-foreach-as-a-list">Return the foreach as a list</a></li>
  <li><a href="#dont-preallocate-the-for" id="toc-dont-preallocate-the-for" class="nav-link" data-scroll-target="#dont-preallocate-the-for">Don’t preallocate the for</a></li>
  </ul></li>
  <li><a href="#un-parallelising" id="toc-un-parallelising" class="nav-link" data-scroll-target="#un-parallelising">Un-parallelising</a>
  <ul class="collapse">
  <li><a href="#foreach-do" id="toc-foreach-do" class="nav-link" data-scroll-target="#foreach-do">foreach %do%</a></li>
  <li><a href="#list-foreach-do" id="toc-list-foreach-do" class="nav-link" data-scroll-target="#list-foreach-do">list foreach %do%</a></li>
  <li><a href="#plansequential" id="toc-plansequential" class="nav-link" data-scroll-target="#plansequential">plan(sequential)</a>
  <ul class="collapse">
  <li><a href="#the-message-so-far" id="toc-the-message-so-far" class="nav-link" data-scroll-target="#the-message-so-far">The message so far</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#create-the-data-in-the-function" id="toc-create-the-data-in-the-function" class="nav-link" data-scroll-target="#create-the-data-in-the-function">Create the data in the function</a>
  <ul class="collapse">
  <li><a href="#foreach-1" id="toc-foreach-1" class="nav-link" data-scroll-target="#foreach-1">foreach</a></li>
  <li><a href="#furrrr" id="toc-furrrr" class="nav-link" data-scroll-target="#furrrr">furrrr</a></li>
  <li><a href="#future.apply-1" id="toc-future.apply-1" class="nav-link" data-scroll-target="#future.apply-1">future.apply</a></li>
  <li><a href="#for" id="toc-for" class="nav-link" data-scroll-target="#for">For</a></li>
  <li><a href="#future-for-1" id="toc-future-for-1" class="nav-link" data-scroll-target="#future-for-1">future for</a></li>
  <li><a href="#globals" id="toc-globals" class="nav-link" data-scroll-target="#globals">Globals</a>
  <ul class="collapse">
  <li><a href="#foreach-2" id="toc-foreach-2" class="nav-link" data-scroll-target="#foreach-2">foreach</a></li>
  <li><a href="#furrrr-1" id="toc-furrrr-1" class="nav-link" data-scroll-target="#furrrr-1">furrrr</a></li>
  <li><a href="#future.apply-2" id="toc-future.apply-2" class="nav-link" data-scroll-target="#future.apply-2">future.apply</a></li>
  </ul></li>
  <li><a href="#benchmark-1" id="toc-benchmark-1" class="nav-link" data-scroll-target="#benchmark-1">Benchmark</a></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../parallelism/interrogating_parallel.html">R parallel processing (general)</a></li><li class="breadcrumb-item"><a href="../parallelism/parallel_speed.html">Speed-testing parallel</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Investigating parallel speedups</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Galen Holt </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>I tend to run a lot of code that can be parallelised, but it’s not always clear when it’s worth it and how best to structure the paralellisation. Should it be at the outermost layer, where I’m typically looping over parameters, some intermediate layer where I might be looping over indices or iterators, or to handle large datasets?</p>
<p>For reference, I often have population dynamics models with many species and locations. At each timestep I need to make a lot of calculations on the species, including some large matrix multiplications to get dispersal. These could be parallelised over species. And after simulations are complete, I calculate a lot of covariances over species, space, and time that can be parallelised over pairwise combinations. Both of these cases operate on large arrays, and so would feed large amounts of data to parallelised functions, which would then do some limited processing on it (e.g.&nbsp;calculate covariances and clean them up for return). At the other extreme, each of these situations is governed by an initial set of parameters, giving, for example, environmental conditions, species growth rates, etc. These are often just vectors, and so parallelising over them would feed the parallel function small amounts of data and kick off large amounts of work.</p>
<p>To test parallel performance under these different situations, I’ll attempt to build an example that is non-trivial, but still try to stay minimally complex to avoid getting into writing a complex population dynamics model.</p>
<section id="packages-and-setup" class="level2">
<h2 class="anchored" data-anchor-id="packages-and-setup">Packages and setup</h2>
<p>I’ll use the {future} package, along with {dofuture} and {foreach}, because I tend to like writing for loops (there’s a reason- I’ll try to write up sometime later). I’ll also test {furrr} and {future.apply} to see if they differ in any appreciable way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doRNG)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(listenv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just set up a typical doFuture situation with <code>plan(multisession)</code>. Sorting out plans is a topic for another day.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-data-heavy-loop" class="level1">
<h1>A data-heavy loop</h1>
<p>Let’s just say it’s a biggish (but not obscene) matrix multiplication, which for a single iteration (maybe this is species 1’s dispersal) looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">1000</span>), <span class="at">nrow =</span> <span class="dv">1000</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(c <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b, <span class="at">times =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
         expr      min       lq     mean   median     uq    max neval
 c &lt;- a %*% b 1.213801 1.345602 1.475621 1.442501 1.6289 1.7425    10</code></pre>
</div>
</div>
<p>Now, let’s say we have a lot of species- ie there are 100 <code>a</code>’s in the situation above. I’ll put them in a list so I can use <code>foreach</code> or <code>furrr</code> or <code>future.apply</code> might make the most sense. My code often makes the most sense in loops because of dependencies and so I tend to keep writing them, but anything parallelisable should be able to be coerced into working with <code>furrr</code> or <code>future.apply.</code></p>
<p>So, let’s say I have 100 ‘species’ that each get multiplied by the b above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>a100 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">100</span><span class="sc">*</span><span class="dv">1000</span>), <span class="at">ncol =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In a single- case, this is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> a100[,<span class="dv">1</span>] <span class="sc">%*%</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So what we want to do is multiply each column of a100 by b and then glue them back together. And yes, we could do all this more cleanly with linear algebra. The point here is to test the situation where we have a reasonably large amount of data we want to iterate over and do some smallish number of operations on. I’ll make each one a function so we can easily run them through <code>microbenchmark</code> (and later, nest them).</p>
<section id="foreach" class="level2">
<h2 class="anchored" data-anchor-id="foreach">foreach</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mult_foreach <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a), <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_foreach))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="furrr" class="level2">
<h2 class="anchored" data-anchor-id="furrr">furrr</h2>
<p><code>purrr</code> (and so <code>furrr</code>) don’t seem to work on matrices. So, I guess have a silly pre-step to make it a list. I’m going to do that outside the function, simply because if we went this way, we’d set the data up to work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mult_furrr <span class="ot">&lt;-</span> <span class="cf">function</span>(a_list, b) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  c_map <span class="ot">&lt;-</span> <span class="fu">future_map</span>(a_list, \(x) x <span class="sc">%*%</span> b)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_map), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future.apply" class="level2">
<h2 class="anchored" data-anchor-id="future.apply">future.apply</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mult_apply <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">future_apply</span>(a, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">%*%</span> b)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-for" class="level2">
<h2 class="anchored" data-anchor-id="simple-for">simple for</h2>
<p>Preallocate, because I’m not a heathen</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mult_for <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> a</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    c_for[,i] <span class="ot">&lt;-</span> a[,i] <span class="sc">%*%</span> b</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_for)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future-for" class="level2">
<h2 class="anchored" data-anchor-id="future-for">future for</h2>
<p>We can write a usual for loop if we use futures directly. the futures themselves have to go in a list, because they are futures, not values, and so can’t go straight into a matrix. That list <em>can</em> be preallocated.</p>
<p>There are two ways to do this- explicit and implicit- <a href="https://github.com/HenrikBengtsson/future">see the future docs</a>.</p>
<section id="explicit-futures" class="level4">
<h4 class="anchored" data-anchor-id="explicit-futures">Explicit futures</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_e <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">'list'</span>, <span class="at">length =</span> <span class="fu">ncol</span>(a))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="ot">&lt;-</span> <span class="fu">future</span>({a[,i] <span class="sc">%*%</span> b})</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">lapply</span>(c_for, <span class="at">FUN =</span> value)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> <span class="fu">ncol</span>(a)))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implicit-futures" class="level4">
<h4 class="anchored" data-anchor-id="implicit-futures">Implicit futures</h4>
<p>using <code>listenv</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_i <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">listenv</span>()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="sc">%&lt;-%</span> {a[,i] <span class="sc">%*%</span> b}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">as.list</span>(c_for)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> <span class="fu">ncol</span>(a)))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="linear-algebra" class="level2">
<h2 class="anchored" data-anchor-id="linear-algebra">linear algebra</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mult_linear <span class="ot">&lt;-</span> <span class="cf">function</span>(a,b) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="test-they-all-work" class="level1">
<h1>Test they all work</h1>
<p>set up a small test case and see if they are all returning the same answer</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>asmall <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">2</span>), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>asmall_l <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">as.data.frame</span>(asmall)) <span class="co"># This is silly</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>bsmall <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">10</span>), <span class="at">ncol =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>c_foreach <span class="ot">&lt;-</span> <span class="fu">mult_foreach</span>(asmall, bsmall)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>c_furrr <span class="ot">&lt;-</span> <span class="fu">mult_furrr</span>(asmall_l, bsmall)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>c_apply <span class="ot">&lt;-</span> <span class="fu">mult_apply</span>(asmall, bsmall)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>c_for <span class="ot">&lt;-</span> <span class="fu">mult_for</span>(asmall, bsmall)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>c_for_fe <span class="ot">&lt;-</span> <span class="fu">mult_for_future_e</span>(asmall, bsmall)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>c_for_fi <span class="ot">&lt;-</span> <span class="fu">mult_for_future_i</span>(asmall, bsmall)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>c_linear <span class="ot">&lt;-</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(asmall), bsmall)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_furrr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_apply)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_for)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_for_fe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_for_fi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(c_foreach <span class="sc">==</span> c_linear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="benchmark" class="level1">
<h1>Benchmark</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>a100_l <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">as.data.frame</span>(a100))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr</span>(a100_l, b),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply</span>(a100, b),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">future_for_e =</span> <span class="fu">mult_for_future_e</span>(a100, b),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">future_for_i =</span> <span class="fu">mult_for_future_i</span>(a100, b),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
          expr        min         lq        mean      median         uq
 futureforeach  2391.7859  2547.7285  2824.28290  2858.64935  3109.1553
   futurefurrr  2735.9775  2758.9662  3276.79272  3026.24630  3230.1335
   futureapply  2563.8114  2641.1631  2797.72951  2722.93280  2952.8528
      bare_for    91.1790    98.1436   107.60745   106.17695   108.6603
  future_for_e 13317.3280 14126.5008 15066.07841 15425.70625 15793.8948
  future_for_i 13905.7498 14113.6200 14788.64297 14595.06900 15508.8098
   bare_linear    39.3198    43.7770    46.23252    44.91655    45.9903
        max neval
  3168.6752    10
  5711.8441    10
  3171.3136    10
   137.4717    10
 16143.9597    10
 15898.4413    10
    60.5414    10</code></pre>
</div>
</div>
<p>Well, that’s interesting. The futures are hugely slower than even the bare <code>for</code>. And the direct futures in a <code>for</code> are the worst by far (so bad there must be something major wrong). Is it just overhead passing the matrices to workers? That might explain the poor performance of the direct futures in <code>for</code>- if the other <code>future</code> functions chunk to avoid passing everything every time, then the overhead hits the direct versions much harder. Or something else? Does preallocating help for the foreach, apply, etc?</p>
</section>
<section id="preallocation-and-lists" class="level1">
<h1>Preallocation and lists</h1>
<p>This is a bit of an aside- we <em>know</em> preallocation speeds up <code>for</code> loops. Does it speed up <code>foreach</code>? Seems unlikely, since by nature <code>foreach</code> constructs the object additively as a list or whatever’s specified in <code>.combine</code>. That can make the code cleaner in a lot of cases if we’re building something in a loop, but it seems more like the un-preallocated <code>for</code> method of doing things.</p>
<p>Let’s test and see.</p>
<section id="preallocate-the-foreach" class="level2">
<h2 class="anchored" data-anchor-id="preallocate-the-foreach">preallocate the foreach</h2>
<p>I typically don’t do this, since my understanding of foreach is that it builds them with the .combine, so preallocating doesn’t do anything. But maybe?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_pre <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">t</span>(a)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a), <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_foreach))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="return-the-foreach-as-a-list" class="level2">
<h2 class="anchored" data-anchor-id="return-the-foreach-as-a-list">Return the foreach as a list</h2>
<p>It is possible that using <code>.combine</code> is forcing slower behaviour for the foreach, and it’s optimized for a list?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_list <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) <span class="sc">%dopar%</span> {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do the binding in one step</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(c_foreach), <span class="at">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dont-preallocate-the-for" class="level2">
<h2 class="anchored" data-anchor-id="dont-preallocate-the-for">Don’t preallocate the for</h2>
<p>How bad is this- I almost always DO preallocate (it’s faster, and the loop starts at 1, and it’s just cleaner), but it’s possible not to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>mult_for_build <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> a[,<span class="dv">1</span>] <span class="sc">%*%</span> b</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(a)) {</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    ctemp <span class="ot">&lt;-</span> a[,i] <span class="sc">%*%</span> b</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    c_for <span class="ot">&lt;-</span> <span class="fu">rbind</span>(c_for, ctemp)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_for))</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll include the <code>furrr</code> and <code>future.apply</code> here too, I guess as reference.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr</span>(a100_l, b),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply</span>(a100, b),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">preallocate_foreach =</span> <span class="fu">mult_foreach_pre</span>(a100, b),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">foreach_list =</span> <span class="fu">mult_foreach_list</span>(a100, b),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">unallocate_for =</span> <span class="fu">mult_for_build</span>(a100, b),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                expr       min        lq       mean    median        uq
         futurefurrr 2571.1246 2767.6439 2857.16904 2866.4501 2897.1658
         futureapply 2507.3732 2652.2697 2799.40048 2846.0770 2917.3628
       futureforeach 2293.2059 2438.9546 2593.98055 2637.0460 2725.0197
 preallocate_foreach 2343.7728 2587.9531 2620.46876 2612.0335 2671.4092
        foreach_list 2291.8114 2404.4547 2544.75845 2517.0032 2714.5863
            bare_for   93.8633   99.2174  100.78608   99.9848  101.3844
      unallocate_for  117.2363  120.5628  124.45097  124.5449  127.4235
         bare_linear   40.2038   40.7167   42.76278   42.6698   43.5522
       max neval
 3297.9195    10
 3056.1415    10
 2785.5028    10
 2820.4449    10
 2794.5918    10
  109.7385    10
  132.2418    10
   47.7955    10</code></pre>
</div>
</div>
<p>These results are interesting, and the actual <em>slowdown</em> (not just lack of speedup) is worrying for how I do some things. I think the overhead of shifting the data around is absolutely killing these parallel processes. And I definitely have code that does this sort of thing.</p>
<p>I have two more questions now (plus one for later):</p>
<ol type="1">
<li><p>Does the <code>foreach</code> loop work as fast as a <code>for</code> if I use <code>%do%</code> instead of <code>%dopar%</code>? Or is the overhead still there?</p>
<ol type="1">
<li>And same with all the futures if I set <code>plan(sequential)</code>?</li>
</ol></li>
<li><p>If I don’t send prebuilt data, but just some parameters and build the data internally, how do they compare?</p>
<ol type="1">
<li>Sometimes this flow makes sense, and sometimes it doesn’t– e.g.&nbsp;if I’m simulating populations, the outer set of parallelisation just sends parameters. But the internal set often needs to work on things like population matrices. And so maybe that internal loop just shouldn’t be parallel.</li>
</ol></li>
<li><p>How do other <code>plan</code> options affect these answers? I think this deserves its own page, and could get very complicated once I get into <code>future.callr</code>, <code>future.batchtools</code>, <code>cluster</code>, etc. And <code>multicore</code> might avoid the passing and use pointers, but i can’t test on windows?</p></li>
</ol>
</section>
</section>
<section id="un-parallelising" class="level1">
<h1>Un-parallelising</h1>
<section id="foreach-do" class="level2">
<h2 class="anchored" data-anchor-id="foreach-do">foreach %do%</h2>
<p>Let’s try shifting to <code>%do%</code> for the foreach</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_do <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a), <span class="at">.combine =</span> rbind) <span class="sc">%do%</span> {</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t</span>(c_foreach))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="list-foreach-do" class="level2">
<h2 class="anchored" data-anchor-id="list-foreach-do">list foreach %do%</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_list_do <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(a)) <span class="sc">%do%</span> {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    a[,i] <span class="sc">%*%</span> b</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do the binding in one step</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(c_foreach), <span class="at">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test against parallel foreach, bare for, and the unallocated for (since that’s kind of what the foreach is doing- building up an object). Since that’s sometimes nice behaviour and leads to cleaner code than a for loop, I’d like to see how they compare.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">foreachdo =</span> <span class="fu">mult_foreach_do</span>(a100, b),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">foreachlistdo =</span> <span class="fu">mult_foreach_list_do</span>(a100, b),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">unallocate_for =</span> <span class="fu">mult_for_build</span>(a100, b),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
           expr       min        lq       mean    median        uq       max
  futureforeach 2294.3315 2413.2883 2441.58145 2426.2623 2491.8492 2593.4213
      foreachdo  108.1478  110.7516  117.48842  118.1481  122.2505  128.2518
  foreachlistdo  110.9159  111.7610  118.85446  117.0267  119.7476  144.9399
       bare_for   91.0620   96.5476  106.97241  108.5482  112.5208  131.5772
 unallocate_for  116.1919  120.7025  124.04948  124.7919  127.6500  130.3755
    bare_linear   39.1770   40.9914   42.25231   42.5430   43.0318   46.4730
 neval
    10
    10
    10
    10
    10
    10</code></pre>
</div>
</div>
<p>Interesting. Nearly identical to the unallocated for and quite a bit <em>faster</em> than the parallel version, which seems to hint that it’s the data transfer that’s killing things. And backs up my assumption of what’s going on under the hood in terms of constructing the object as in an unallocated for loop. There’s no appreciable difference in using the foreach with a list and then combining vs combining as we go with <code>.combine</code>.</p>
</section>
<section id="plansequential" class="level2">
<h2 class="anchored" data-anchor-id="plansequential">plan(sequential)</h2>
<p>How do the parallel versions work with <code>plan(sequential)</code>? Do they all get a speedup from avoiding data transfer? This is the same benchmark test as above, but now run sequentially.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(sequential)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr</span>(a100_l, b),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply</span>(a100, b),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach</span>(a100, b),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for</span>(a100, b),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">unallocate_for =</span> <span class="fu">mult_for_build</span>(a100, b),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_linear =</span> <span class="fu">mult_linear</span>(<span class="fu">t</span>(a100), b),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
           expr      min       lq      mean   median       uq      max neval
    futurefurrr 116.6781 119.5224 124.35162 125.1431 127.5115 134.7231    10
    futureapply 105.6057 110.9022 114.05056 113.2071 119.2455 120.0307    10
  futureforeach 115.8364 123.0657 127.43182 125.7630 128.5088 141.5289    10
       bare_for  92.1208 103.9310 108.69223 110.5858 113.8986 118.0519    10
 unallocate_for 118.7530 123.6296 127.38882 125.9754 130.5657 140.5084    10
    bare_linear  40.6936  42.4847  43.83156  44.3669  44.9938  45.7687    10</code></pre>
</div>
</div>
<p>Interesting. <code>foreach</code> and <code>furrr</code> both sped up about as expected (<code>furrr</code> just seems a bit slower in general), but <code>future.apply</code> had much less of a speedup. It must not fall back to a simpler function, and still tries to use the parallel data shuffling? It is still much faster than with <code>plan(multisession)</code> (was 590 microseconds), so something is happening, but it’s not getting down to the speeds of the other futures. And the simple <code>for</code> is still fastest (other than just using linear algebra, obviously).</p>
<section id="the-message-so-far" class="level3">
<h3 class="anchored" data-anchor-id="the-message-so-far">The message so far</h3>
<p>Test the parallel implementation at different points in the code- if there’s no way to avoid data passing, a simple <code>for</code> (or other sequential function like <code>apply</code> could be fastest.</p>
</section>
</section>
</section>
<section id="create-the-data-in-the-function" class="level1">
<h1>Create the data in the function</h1>
<p>Sometimes it does work (or makes more sense) to create the data inside each parallel process. This is certainly the case where we’re looping over parameter sets for simulations, which tend to be embarassingly parallel and low-data, which then sets of lots of processing. It’s <em>also</em> likely to be the case in another situation I encounter often- reading chunks of large raster data, where I can keep it as <code>stars_proxy</code> objects until inside a parallel loop, where I can bring a chunk into memory. Something similar is likely true of things like netcdf reading.</p>
<p>To test this sort of situation, let’s use the same functions as above, but now create the vectors and matrices internally, rather than pass them in. I’m going to remake the <code>b</code> matrix internally because the point is to check this use of parallelism (lots of processing triggered from small data), even though in practice for this particular sort of calculation we’d need to pass it in so it’s common to all the a’s. Here, it’s just a stand-in for “do some work”. Let’s make the first argument actually do something other than just replicate, so have it set the mean of <code>a</code>.</p>
<p>I’m not going to bother with setting seeds because it’ll be a pain to get them to match across the different ways of doing this, so the answers will be different.</p>
<p>Do we need to adjust globals here? If we leave defaults, we copy in the whole parent environment, right? and so don’t end-run anything? e.g.&nbsp;<code>.options = furrr_options(globals = "y")</code> for <code>furrr</code>? No, see tests of this below- <code>future</code> only passes in the needed objects from global.</p>
<p>Turn parallel processing back on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="foreach-1" class="level3">
<h3 class="anchored" data-anchor-id="foreach-1">foreach</h3>
<p>changing this a bit too so <em>all</em> the work is done inside (no <code>t</code> on the return)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n_reps, <span class="at">.combine =</span> cbind) <span class="sc">%dorng%</span> {</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_foreach)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="furrrr" class="level3">
<h3 class="anchored" data-anchor-id="furrrr">furrrr</h3>
<p>reframing this one too, because <code>future_map</code> needs to call the function that does all the generating. This construction gets contrived very quickly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>mult_furrr_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  c_map <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, fn_to_call, <span class="at">size =</span> size, <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_map), <span class="at">ncol =</span> n_reps)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future.apply-1" class="level3">
<h3 class="anchored" data-anchor-id="future.apply-1">future.apply</h3>
<p>modifying to <code>future_lapply</code> because it doesn’t make sense to <code>apply</code> over the margins of a matrix that gets created. Again, this is getting contrived.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>mult_apply_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  c_apply <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, <span class="at">FUN =</span> fn_to_call, size, <span class="at">future.seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_apply), <span class="at">ncol =</span> n_reps)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="for" class="level3">
<h3 class="anchored" data-anchor-id="for">For</h3>
<p>back to preallocating- we know it’s better</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mult_for_internal <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> size, <span class="at">ncol =</span> n_reps)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps) {</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        c_for[,i] <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_for)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future-for-1" class="level2">
<h2 class="anchored" data-anchor-id="future-for-1">future for</h2>
<p>We can write a usual for loop if we use futures directly. the futures themselves have to go in a list, because they are futures, not values, and so can’t go straight into a matrix. That list <em>can</em> be preallocated.</p>
<p>There are two ways to do this- explicit and implicit- <a href="https://github.com/HenrikBengtsson/future">see the future docs</a>.</p>
<section id="explicit-futures-1" class="level4">
<h4 class="anchored" data-anchor-id="explicit-futures-1">Explicit futures</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_internal_e <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">'list'</span>, <span class="at">length =</span> n_reps)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps) {</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="ot">&lt;-</span> <span class="fu">future</span>({a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">%*%</span> b}, <span class="at">seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">lapply</span>(c_for, <span class="at">FUN =</span> value)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> n_reps))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implicit-futures-1" class="level4">
<h4 class="anchored" data-anchor-id="implicit-futures-1">Implicit futures</h4>
<p>using <code>listenv</code></p>
<p>That’s a funny way to set the seed. Good to know.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>mult_for_future_internal_i <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  c_for <span class="ot">&lt;-</span> <span class="fu">listenv</span>()</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_reps) {</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    c_for[[i]] <span class="sc">%&lt;-%</span> {a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">%*%</span> b} <span class="sc">%seed%</span> <span class="cn">TRUE</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get values and make a matrix</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  v_for <span class="ot">&lt;-</span> <span class="fu">as.list</span>(c_for)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(v_for), <span class="at">ncol =</span> n_reps))</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There’s no reason to have a linear algebra version here, since we’re by definition not operating on existing matrices.</p>
<p>Try that <em>without</em> adjusting what globals are passed to the futures</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefor_e =</span> <span class="fu">mult_for_future_internal_e</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefor_i =</span> <span class="fu">mult_for_future_internal_i</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: seconds
          expr       min        lq      mean    median        uq       max
   futurefurrr  2.911519  2.937818  3.446520  3.176596  3.296120  6.415807
   futureapply  2.824095  2.847494  3.067614  3.021533  3.228708  3.546101
 futureforeach  2.829144  2.940019  3.237918  3.160864  3.245488  4.222348
   futurefor_e 12.650138 13.192132 13.856649 13.579496 14.916949 15.034860
   futurefor_i 13.213725 13.252212 13.510405 13.378892 13.803717 14.127473
      bare_for  3.626247  3.706880  3.980060  4.089718  4.211040  4.323426
 neval
    10
    10
    10
    10
    10
    10</code></pre>
</div>
</div>
<p>Now the parallelisation <em>is</em> helping quite a bit, even the <code>for</code> loops with futures, though they’re still much slower than the other <code>future</code> methods. However, this is much slower than creating the matrices as we actually should do for this particular calculation, and is even slower than passing those matrices in. So, if the operations need to happen this way anyway (parallel lots of stuff over parameters), this makes lots of sense and speeds up. If we CAN pre-generate matrices, linear algebra is fastest (unsurprisingly), and the loops are next, even if we have to eat pass-in cost. Though in that case sequential is probably better.</p>
<p>I think the slower bare futures are likely because there’s no chunking being done, and so data is copied to <em>each</em> iteration, rather than to chunks of iterations (which is built into <code>doFuture</code> and I think <code>furrr</code> and <code>future.apply</code>. I could try to manually chunk to test that, but I think I’m just going to skip it.</p>
</section>
</section>
<section id="globals" class="level2">
<h2 class="anchored" data-anchor-id="globals">Globals</h2>
<p>One of the nice things about <code>future</code> compared to some other parallel backends is that it does pass the global environment, so i don’t have to manage what it gets- it works as it does interactively. BUT, if data passing is what’s killing the speed, maybe I <em>do</em> need to manage what gets passed. In theory, the test above should get even faster if we don’t pass it the global environment, but <em>only</em> the arguments.</p>
<p>So, a new version of the above, explicitly limiting passing.</p>
<section id="foreach-2" class="level3">
<h3 class="anchored" data-anchor-id="foreach-2">foreach</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>mult_foreach_internal_g <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  c_foreach <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n_reps, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> cbind,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.export =</span> <span class="cn">NULL</span>) <span class="sc">%dorng%</span> {</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c_foreach)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="furrrr-1" class="level3">
<h3 class="anchored" data-anchor-id="furrrr-1">furrrr</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mult_furrr_internal_g <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  c_map <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, fn_to_call, <span class="at">size =</span> size, </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>, <span class="at">globals =</span> <span class="cn">NULL</span>))</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_map), <span class="at">ncol =</span> n_reps)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future.apply-2" class="level3">
<h3 class="anchored" data-anchor-id="future.apply-2">future.apply</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>mult_apply_internal_g <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>) {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    fn_to_call <span class="ot">&lt;-</span> <span class="cf">function</span>(rep, size) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> rep)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size <span class="sc">*</span> size), <span class="at">nrow =</span> size)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(a <span class="sc">%*%</span> b)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  c_apply <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_reps, <span class="at">FUN =</span> fn_to_call, size, </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">future.seed =</span> <span class="cn">TRUE</span>, <span class="at">future.globals =</span> <span class="cn">FALSE</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(<span class="fu">unlist</span>(c_apply), <span class="at">ncol =</span> n_reps)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="benchmark-1" class="level2">
<h2 class="anchored" data-anchor-id="benchmark-1">Benchmark</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr =</span> <span class="fu">mult_furrr_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply =</span> <span class="fu">mult_apply_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach =</span> <span class="fu">mult_foreach_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">futurefurrr_g =</span> <span class="fu">mult_furrr_internal_g</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureapply_g =</span> <span class="fu">mult_apply_internal_g</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">futureforeach_g =</span> <span class="fu">mult_foreach_internal_g</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bare_for =</span> <span class="fu">mult_for_internal</span>(<span class="at">n_reps =</span> <span class="dv">100</span>, <span class="at">size =</span> <span class="dv">1000</span>),</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: seconds
            expr      min       lq     mean   median       uq      max neval
     futurefurrr 2.934941 2.991153 3.073430 3.036014 3.115680 3.383588    10
     futureapply 2.961602 2.986763 3.314419 3.268155 3.529925 3.972054    10
   futureforeach 2.981263 2.996048 3.114741 3.084971 3.208947 3.359805    10
   futurefurrr_g 2.852686 2.938126 3.049807 3.008130 3.150936 3.425673    10
   futureapply_g 2.933841 3.054000 3.218608 3.119524 3.173425 3.860498    10
 futureforeach_g 2.941432 3.039213 3.142060 3.138042 3.216203 3.484246    10
        bare_for 3.615668 3.733735 3.783454 3.758691 3.801958 4.025737    10</code></pre>
</div>
</div>
<p>So, that’s not hauling around a ton of extra stuff. I think, based on <a href="https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html">the doFuture vignette</a>, that <code>future</code> will send the globals, but only those that are needed. So it’s not that they’re in functions, it’s that <code>future</code> can tell it doesn’t need to pass extra variables. This means we don’t really get performance gains because <code>future</code> already had our back.</p>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<ul>
<li><p>If we can just write good linear algebra, that’s best. No surprise there. But sometimes we can’t.</p></li>
<li><p>If we have large amounts of data, it’s likely fastest to use a preallocated <code>for</code> loop or <code>apply</code> or <code>purrr::map</code> other sequential operation.</p>
<ul>
<li>Even if we <em>have</em> to parallelise and take a performance hit (why? who knows? maybe because it’s buried in a function that needs the ability to be parallel if it’s the outer function?), passing in existing data is still faster than generating the data inside (over what range of data sizes?). But sometimes we need to generate the data inside anyway. In which case-</li>
</ul></li>
<li><p>If we have a bunch of work to do, based on small amounts of data (e.g.&nbsp;parameters, iterators), then the parallel futures are best, without much difference between the flavours.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Website created by Galen Holt</p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="mailto:g.holt@deakin.edu.au">
<p>Contact</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/galenholt">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com.au/citations?user=f94WBOoAAAAJ&amp;hl=en">
      <i class="bi bi-mortarboard-fill" role="img" aria-label="Google Scholar">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/galen-holt-265aa290">
      <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://fediscience.org/@galen_holt">
      <i class="bi bi-mastodon" role="img" aria-label="Mastodon">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>