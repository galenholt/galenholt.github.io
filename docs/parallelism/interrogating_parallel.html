<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Galen Holt">

<title>Galen - Interrogating parallel functions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Galen</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../code_demos.html">
 <span class="menu-text">Code Demos</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#packages-and-setup" id="toc-packages-and-setup" class="nav-link active" data-scroll-target="#packages-and-setup">Packages and setup</a></li>
  <li><a href="#workers-and-cores" id="toc-workers-and-cores" class="nav-link" data-scroll-target="#workers-and-cores">Workers and cores</a></li>
  <li><a href="#the-setup--nested-functions" id="toc-the-setup--nested-functions" class="nav-link" data-scroll-target="#the-setup--nested-functions">The setup- nested functions</a></li>
  <li><a href="#pid-division" id="toc-pid-division" class="nav-link" data-scroll-target="#pid-division">PID division</a>
  <ul class="collapse">
  <li><a href="#sequential-outer-loop" id="toc-sequential-outer-loop" class="nav-link" data-scroll-target="#sequential-outer-loop">sequential outer loop</a></li>
  <li><a href="#nested-with" id="toc-nested-with" class="nav-link" data-scroll-target="#nested-with">Nested with %:%</a></li>
  <li><a href="#list-plans" id="toc-list-plans" class="nav-link" data-scroll-target="#list-plans">List-plans</a>
  <ul class="collapse">
  <li><a href="#naive--just-defaults" id="toc-naive--just-defaults" class="nav-link" data-scroll-target="#naive--just-defaults">Naive- just defaults</a></li>
  <li><a href="#tweak-outer-plan" id="toc-tweak-outer-plan" class="nav-link" data-scroll-target="#tweak-outer-plan">Tweak outer plan</a></li>
  <li><a href="#tweak-both-plans" id="toc-tweak-both-plans" class="nav-link" data-scroll-target="#tweak-both-plans">Tweak both plans</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#interpreting-the-nested-speed-results" id="toc-interpreting-the-nested-speed-results" class="nav-link" data-scroll-target="#interpreting-the-nested-speed-results">Interpreting the nested speed results</a></li>
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions">Functions</a>
  <ul class="collapse">
  <li><a href="#inner-loop" id="toc-inner-loop" class="nav-link" data-scroll-target="#inner-loop">Inner loop</a>
  <ul class="collapse">
  <li><a href="#parallel-version" id="toc-parallel-version" class="nav-link" data-scroll-target="#parallel-version">Parallel version</a></li>
  <li><a href="#sequential-version" id="toc-sequential-version" class="nav-link" data-scroll-target="#sequential-version">Sequential version</a></li>
  <li><a href="#using-preallocated-for" id="toc-using-preallocated-for" class="nav-link" data-scroll-target="#using-preallocated-for">Using preallocated for</a></li>
  </ul></li>
  <li><a href="#outer-loop" id="toc-outer-loop" class="nav-link" data-scroll-target="#outer-loop">Outer loop</a>
  <ul class="collapse">
  <li><a href="#parallel" id="toc-parallel" class="nav-link" data-scroll-target="#parallel">parallel</a></li>
  <li><a href="#sequential" id="toc-sequential" class="nav-link" data-scroll-target="#sequential">sequential</a></li>
  <li><a href="#un-preallocated-for" id="toc-un-preallocated-for" class="nav-link" data-scroll-target="#un-preallocated-for">Un-preallocated for</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#checking-pids" id="toc-checking-pids" class="nav-link" data-scroll-target="#checking-pids">Checking PIDs</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Interrogating parallel functions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Galen Holt </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>In testing parallel functions, especially on new machines, or if we’re trying to get a granular understanding of what they’re doing, we will want to do more than benchmark. We might, for example, want to know what cores and processes they’r using to make sure they’re taking full advantage of resources, or to better understand how resources get divided up, or to better understand the differences between <code>plan</code>s.</p>
<p>I’ve done some <a href="../parallelism/parallel_speed.html">basic speed testing of parallel functions</a> as well as some <a href="../parallelism/nested_parallel.html">testing of nested functions</a> Here, I’ll build on that to better understand how the workers get divided up in those nested functions, and use that to jump off into testing different <code>plan</code>s.</p>
<section id="packages-and-setup" class="level2">
<h2 class="anchored" data-anchor-id="packages-and-setup">Packages and setup</h2>
<p>I’ll use the {future} package, along with {dofuture} and {foreach}, because I tend to like writing for loops (there’s a reason I’ll try to write up sometime later). I test other packages in the {future} family (<code>furrr</code>, <code>future_apply</code>) <a href="parallelism/parallel_speed.qmd">where I try to better understand when they do and don’t give speed advantages</a>.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-1_d93c8d94b11ba30e0298f13b09ece208">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: foreach</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: future</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doRNG)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rngtools</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="workers-and-cores" class="level2">
<h2 class="anchored" data-anchor-id="workers-and-cores">Workers and cores</h2>
<p>We get assigned workers and cores when we call <code>plan</code> . We can also get the outer process id</p>
<p><em>note</em> on HPC, we need to use <code>availableCores(methods = 'Slurm')</code> .</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-2_75094373b15d8cb202de5156d1d5593a">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">availableWorkers</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "localhost" "localhost" "localhost" "localhost" "localhost" "localhost"
 [7] "localhost" "localhost" "localhost" "localhost" "localhost" "localhost"
[13] "localhost" "localhost" "localhost" "localhost" "localhost" "localhost"
[19] "localhost" "localhost"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">availableCores</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>system 
    20 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.getpid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 21416</code></pre>
</div>
</div>
</section>
<section id="the-setup--nested-functions" class="level2">
<h2 class="anchored" data-anchor-id="the-setup--nested-functions">The setup- nested functions</h2>
<p>I’ll use the inner and outer parallel functions similar to my <a href="../parallelism/nested_parallel.html">tests of nested functions</a>, but instead of doing anything, they’ll just track the processes.</p>
<p>What do I want to interrogate? The process id, for one- I can use <code>Sys.getpid()</code>. I think I might just skip all the actual processing and just get the IDs</p>
<p>What do I want to check? How the processes get divvied up. Are the inner loops getting different processes? Are the outer, and then the inner all use that one? Does it change through the outer loop? Does it depend on the number of iterations?</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-3_d483328afcd811628625bc45ea3db8d9">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>inner_par <span class="ot">&lt;-</span> <span class="cf">function</span>(outer_it, size) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  inner_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>size,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%dorng%</span> {</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                         thisproc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">"inner"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">outer_iteration =</span> outer_it,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">inner_iteration =</span> j, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># d &lt;- rnorm(size, mean = j)</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># f &lt;- matrix(rnorm(size*size), nrow = size)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># g &lt;- d %*% f</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean(g)</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the outer loop, let’s check the PID both before and after the inner loop runs.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-4_520bde44b668fbbe6ba2061c5d52afd3">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>outer_par <span class="ot">&lt;-</span> <span class="cf">function</span>(outer_size, innerfun, inner_size) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>outer_size,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%dorng%</span> {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                        outerpre <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">'outer_pre'</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">outer_iteration =</span> i,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">inner_iteration=</span> <span class="cn">NA</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Now iterate over the values in c to do somethign else</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                         inner_out <span class="ot">&lt;-</span> <span class="fu">innerfun</span>(<span class="at">outer_it =</span> i, <span class="at">size =</span> inner_size)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                         outerpost <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">'outer_post'</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">outer_iteration =</span> i,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">inner_iteration=</span> <span class="cn">NA</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">bind_rows</span>(outerpre, inner_out, outerpost)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(outer_out)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pid-division" class="level1">
<h1>PID division</h1>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-5_203c97648e2960aeb6f3ea50cfa9b362">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>test10 <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">10</span>, <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">10</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>test10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 120 × 4
   loop      outer_iteration inner_iteration   pid
   &lt;chr&gt;               &lt;int&gt;           &lt;int&gt; &lt;int&gt;
 1 outer_pre               1              NA 15212
 2 inner                   1               1 15212
 3 inner                   1               2 15212
 4 inner                   1               3 15212
 5 inner                   1               4 15212
 6 inner                   1               5 15212
 7 inner                   1               6 15212
 8 inner                   1               7 15212
 9 inner                   1               8 15212
10 inner                   1               9 15212
# … with 110 more rows</code></pre>
</div>
</div>
<p>Does the PID only change with the outer loop? Looks like yes</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-6_dd68bcda4b4cec0b94ee6a64082ebbaa">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(test10<span class="sc">$</span>outer_iteration, test10<span class="sc">$</span>pid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    
     3888 6508 7164 14208 15212 19180 21476 23860 25532 26460
  1     0    0    0     0    12     0     0     0     0     0
  2     0   12    0     0     0     0     0     0     0     0
  3    12    0    0     0     0     0     0     0     0     0
  4     0    0   12     0     0     0     0     0     0     0
  5     0    0    0     0     0     0     0     0    12     0
  6     0    0    0    12     0     0     0     0     0     0
  7     0    0    0     0     0    12     0     0     0     0
  8     0    0    0     0     0     0     0    12     0     0
  9     0    0    0     0     0     0     0     0     0    12
  10    0    0    0     0     0     0    12     0     0     0</code></pre>
</div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-7_849f8a2bf51b72e0cfb9c16a20a67c7a">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test10, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_binned</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So yes, it assigns the PIDs to the outer loops and doesn’t add more for the inner. Does that change with different sizes?</p>
<p>Let’s check an outer loop with 1, and inner with 10, and vice versa</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-8_bbe538984b5baa6b6d75b71be205b384">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>test1_10 <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">1</span>, <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-9_502bd4e49fed30289e2ea3424b92029d">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>test10_1 <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">10</span>, <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-10_3db78e0a48a599c33168a18d60efed6a">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plot1_10 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test1_10, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>plot10_1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test10_1, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>plot1_10 <span class="sc">+</span> plot10_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So yeah, it <em>always</em> only assigns PIDs to the outer. That means this sort of nested loop doesn’t actually nest- only the outer gets parallelised, at least with plan(multisession).</p>
<p>I’m assuming more iterations doesn’t change that, but let’s push both above the number of workers (20)</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-11_15ab4eaa02869e351f05c823eff801ca">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>test1_50 <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">1</span>, <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">50</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>test50_1 <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">50</span>, <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-12_c0bad81e879d4928fa19f4c5429484cf">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>plot1_50 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test1_50, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>plot50_1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test50_1, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>plot1_50 <span class="sc">+</span> plot50_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Yeah, so the same PID gets re-used across the outer loops but not the inner</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-13_39c846b71eabd2fb9e48eb96ea3102aa">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(test50_1<span class="sc">$</span>outer_iteration, test50_1<span class="sc">$</span>pid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    
     1516 3888 5020 6508 7164 9712 14208 15212 16416 19180 21476 21520 22416
  1     0    0    0    0    0    0     0     3     0     0     0     0     0
  2     0    0    0    0    0    0     0     3     0     0     0     0     0
  3     0    0    0    0    0    0     0     3     0     0     0     0     0
  4     0    0    0    3    0    0     0     0     0     0     0     0     0
  5     0    0    0    3    0    0     0     0     0     0     0     0     0
  6     0    3    0    0    0    0     0     0     0     0     0     0     0
  7     0    3    0    0    0    0     0     0     0     0     0     0     0
  8     0    3    0    0    0    0     0     0     0     0     0     0     0
  9     0    0    0    0    3    0     0     0     0     0     0     0     0
  10    0    0    0    0    3    0     0     0     0     0     0     0     0
  11    0    0    0    0    0    0     0     0     0     0     0     0     0
  12    0    0    0    0    0    0     0     0     0     0     0     0     0
  13    0    0    0    0    0    0     0     0     0     0     0     0     0
  14    0    0    0    0    0    0     3     0     0     0     0     0     0
  15    0    0    0    0    0    0     3     0     0     0     0     0     0
  16    0    0    0    0    0    0     0     0     0     3     0     0     0
  17    0    0    0    0    0    0     0     0     0     3     0     0     0
  18    0    0    0    0    0    0     0     0     0     3     0     0     0
  19    0    0    0    0    0    0     0     0     0     0     0     0     0
  20    0    0    0    0    0    0     0     0     0     0     0     0     0
  21    0    0    0    0    0    0     0     0     0     0     0     0     0
  22    0    0    0    0    0    0     0     0     0     0     0     0     0
  23    0    0    0    0    0    0     0     0     0     0     0     0     0
  24    0    0    0    0    0    0     0     0     0     0     3     0     0
  25    0    0    0    0    0    0     0     0     0     0     3     0     0
  26    3    0    0    0    0    0     0     0     0     0     0     0     0
  27    3    0    0    0    0    0     0     0     0     0     0     0     0
  28    0    0    0    0    0    0     0     0     0     0     0     3     0
  29    0    0    0    0    0    0     0     0     0     0     0     3     0
  30    0    0    0    0    0    0     0     0     0     0     0     3     0
  31    0    0    0    0    0    0     0     0     0     0     0     0     3
  32    0    0    0    0    0    0     0     0     0     0     0     0     3
  33    0    0    0    0    0    0     0     0     0     0     0     0     0
  34    0    0    0    0    0    0     0     0     0     0     0     0     0
  35    0    0    0    0    0    0     0     0     0     0     0     0     0
  36    0    0    0    0    0    0     0     0     3     0     0     0     0
  37    0    0    0    0    0    0     0     0     3     0     0     0     0
  38    0    0    3    0    0    0     0     0     0     0     0     0     0
  39    0    0    3    0    0    0     0     0     0     0     0     0     0
  40    0    0    3    0    0    0     0     0     0     0     0     0     0
  41    0    0    0    0    0    0     0     0     0     0     0     0     0
  42    0    0    0    0    0    0     0     0     0     0     0     0     0
  43    0    0    0    0    0    0     0     0     0     0     0     0     0
  44    0    0    0    0    0    0     0     0     0     0     0     0     0
  45    0    0    0    0    0    0     0     0     0     0     0     0     0
  46    0    0    0    0    0    0     0     0     0     0     0     0     0
  47    0    0    0    0    0    0     0     0     0     0     0     0     0
  48    0    0    0    0    0    3     0     0     0     0     0     0     0
  49    0    0    0    0    0    3     0     0     0     0     0     0     0
  50    0    0    0    0    0    3     0     0     0     0     0     0     0
    
     23860 24320 24768 25372 25532 26460 26808
  1      0     0     0     0     0     0     0
  2      0     0     0     0     0     0     0
  3      0     0     0     0     0     0     0
  4      0     0     0     0     0     0     0
  5      0     0     0     0     0     0     0
  6      0     0     0     0     0     0     0
  7      0     0     0     0     0     0     0
  8      0     0     0     0     0     0     0
  9      0     0     0     0     0     0     0
  10     0     0     0     0     0     0     0
  11     0     0     0     0     3     0     0
  12     0     0     0     0     3     0     0
  13     0     0     0     0     3     0     0
  14     0     0     0     0     0     0     0
  15     0     0     0     0     0     0     0
  16     0     0     0     0     0     0     0
  17     0     0     0     0     0     0     0
  18     0     0     0     0     0     0     0
  19     3     0     0     0     0     0     0
  20     3     0     0     0     0     0     0
  21     0     0     0     0     0     3     0
  22     0     0     0     0     0     3     0
  23     0     0     0     0     0     3     0
  24     0     0     0     0     0     0     0
  25     0     0     0     0     0     0     0
  26     0     0     0     0     0     0     0
  27     0     0     0     0     0     0     0
  28     0     0     0     0     0     0     0
  29     0     0     0     0     0     0     0
  30     0     0     0     0     0     0     0
  31     0     0     0     0     0     0     0
  32     0     0     0     0     0     0     0
  33     0     0     0     3     0     0     0
  34     0     0     0     3     0     0     0
  35     0     0     0     3     0     0     0
  36     0     0     0     0     0     0     0
  37     0     0     0     0     0     0     0
  38     0     0     0     0     0     0     0
  39     0     0     0     0     0     0     0
  40     0     0     0     0     0     0     0
  41     0     0     3     0     0     0     0
  42     0     0     3     0     0     0     0
  43     0     3     0     0     0     0     0
  44     0     3     0     0     0     0     0
  45     0     3     0     0     0     0     0
  46     0     0     0     0     0     0     3
  47     0     0     0     0     0     0     3
  48     0     0     0     0     0     0     0
  49     0     0     0     0     0     0     0
  50     0     0     0     0     0     0     0</code></pre>
</div>
</div>
<section id="sequential-outer-loop" class="level2">
<h2 class="anchored" data-anchor-id="sequential-outer-loop">sequential outer loop</h2>
<p>I assume if we make the outer loop sequential, the inner will then get PIDs</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-14_08741c49cbbc4dc10c55a60a66aca341">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>outer_seq <span class="ot">&lt;-</span> <span class="cf">function</span>(outer_size, innerfun, inner_size) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>outer_size,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%do%</span> {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                        outerpre <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">'outer_pre'</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">outer_iteration =</span> i,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">inner_iteration=</span> <span class="cn">NA</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Now iterate over the values in c to do somethign else</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                         inner_out <span class="ot">&lt;-</span> <span class="fu">innerfun</span>(<span class="at">outer_it =</span> i, <span class="at">size =</span> inner_size)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                         outerpost <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">'outer_post'</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">outer_iteration =</span> i,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">inner_iteration=</span> <span class="cn">NA</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">bind_rows</span>(outerpre, inner_out, outerpost)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(outer_out)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-15_b024da1f2401b6ee84a87238683fd24b">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>testseq10 <span class="ot">&lt;-</span> <span class="fu">outer_seq</span>(<span class="at">outer_size =</span> <span class="dv">10</span>, <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-16_375f0ce81197220f68a2fce4f8665903">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(testseq10, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_binned</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>At least that- if we have a sequential outer, it lets the inner parallelise.</p>
</section>
<section id="nested-with" class="level2">
<h2 class="anchored" data-anchor-id="nested-with">Nested with %:%</h2>
<p>The ‘proper’ way to nest <code>foreach</code> loops is with <code>%:%</code>. That’s not always possible, but I think we can here, to check what they’re getting.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-17_3ebfcf60811b7ecc55cdcb5d2f94a8a5">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>outer_nest <span class="ot">&lt;-</span> <span class="cf">function</span>(outer_size, innerfun, inner_size) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>outer_size,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%:%</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">foreach</span>(<span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>inner_size,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%dopar%</span> {</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                         thisproc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">""</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">outer_iteration =</span> i,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">inner_iteration =</span> j, </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(outer_out)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>note- <code>inner_par</code> isn’t doing anything here, since it’s not a function anymore</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-18_2be80e7641b72b7e0f6276c0b2fb08b2">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>testnest <span class="ot">&lt;-</span> <span class="fu">outer_nest</span>(<span class="dv">10</span>, inner_par, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-19_d0939f1b8d6f970bbf08273c00446960">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(testnest, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_binned</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, each outer loop is getting two PIDs to split up with its inner loop.</p>
<p>So that makes sense- this way <code>foreach</code> knows what’s coming and can split up workers. It looks like the outer loop is favored, though that shouldn’t matter when they’re specified this way.</p>
<p>We can check though</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-20_b3ad59b993c50850829ad10ba7c26ce5">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>testnest50_10 <span class="ot">&lt;-</span> <span class="fu">outer_nest</span>(<span class="dv">50</span>, inner_par, <span class="dv">10</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>testnest10_50 <span class="ot">&lt;-</span> <span class="fu">outer_nest</span>(<span class="dv">10</span>, inner_par, <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-21_c555b0ee8d7b6da216e31f1efe23f827">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>plotnest50_10 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(testnest50_10, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>plotnest10_50 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(testnest10_50, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>plotnest50_10 <span class="sc">+</span> plotnest10_50</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Those look more similar than they are because of different axes. I think that is giving more PIDs to the outer when it has more iterations.</p>
</section>
<section id="list-plans" class="level2">
<h2 class="anchored" data-anchor-id="list-plans">List-plans</h2>
<section id="naive--just-defaults" class="level3">
<h3 class="anchored" data-anchor-id="naive--just-defaults">Naive- just defaults</h3>
<p>There is information out there, largely related to using <code>future.batchtools</code>, that a list of plans lets us handle nested futures. Does that work with <code>multisession</code>?</p>
<p><code>plan("list")</code> tells us what the plan is. This is super helpful for checking what’s going on.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-22_1cfa1f7c9566f471eed549f9cc378f63">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="fu">list</span>(multisession, multisession))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">"list"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of future strategies:
1. multisession:
   - args: function (..., workers = availableCores(), lazy = FALSE, rscript_libs = .libPaths(), envir = parent.frame())
   - tweaked: FALSE
   - call: plan(list(multisession, multisession))
2. multisession:
   - args: function (..., workers = availableCores(), lazy = FALSE, rscript_libs = .libPaths(), envir = parent.frame())
   - tweaked: FALSE
   - call: plan(list(multisession, multisession))</code></pre>
</div>
</div>
<p>Then let’s use the same <code>outer_par</code> we tried earlier</p>
<p>Let’s check an outer loop with 1, and inner with 10, and vice versa</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-23_a35f45d11a9e2e594e092bcd93d0d463">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>test1_10_double <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">1</span>, </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">10</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>test10_1_double <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">10</span>, </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-24_f1a943a27289f7cce69cdde627797c19">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>plot1_10_double <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test1_10_double, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>plot10_1_double <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test10_1_double, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>plot1_10_double <span class="sc">+</span> plot10_1_double</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That didn’t work. BUT, <code>plan("list")</code> shows that the first one uses <code>workers = availableCores()</code>. Does that eat all the cores?</p>
</section>
<section id="tweak-outer-plan" class="level3">
<h3 class="anchored" data-anchor-id="tweak-outer-plan">Tweak outer plan</h3>
<p>If we limit the outer plan, do the ‘leftover’ cores go to the inner?</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-25_a6fb8c7b5f8697b9b5129f10d1d77d9f">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="fu">list</span>(<span class="fu">tweak</span>(multisession, <span class="at">workers =</span> <span class="dv">2</span>), multisession))</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">"list"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of future strategies:
1. multisession:
   - args: function (..., workers = 2, envir = parent.frame())
   - tweaked: TRUE
   - call: plan(list(tweak(multisession, workers = 2), multisession))
2. multisession:
   - args: function (..., workers = availableCores(), lazy = FALSE, rscript_libs = .libPaths(), envir = parent.frame())
   - tweaked: FALSE
   - call: plan(list(tweak(multisession, workers = 2), multisession))</code></pre>
</div>
</div>
<p>Let’s check an outer loop with 1, and inner with 10, and vice versa</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-26_47e01565f5f38802a640897ec44d81ef">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>test1_10_double <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">1</span>, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">10</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>test10_1_double <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">10</span>, </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-27_652eb065a2ea2688c416c6bb76375395">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plot1_10_double <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test1_10_double, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>plot10_1_double <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test10_1_double, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>plot1_10_double <span class="sc">+</span> plot10_1_double</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That restricted the outer, but didn’t give any to the inner. Can I get them there?</p>
</section>
<section id="tweak-both-plans" class="level3">
<h3 class="anchored" data-anchor-id="tweak-both-plans">Tweak both plans</h3>
<p>Now, we’re explicitly telling each plan how many workers it gets.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-28_f217a1eff5689bc336abb4ca283fc00d">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="fu">list</span>(<span class="fu">tweak</span>(multisession, <span class="at">workers =</span> <span class="dv">2</span>), <span class="fu">tweak</span>(multisession, <span class="at">workers =</span> <span class="dv">5</span>)))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">"list"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of future strategies:
1. multisession:
   - args: function (..., workers = 2, envir = parent.frame())
   - tweaked: TRUE
   - call: plan(list(tweak(multisession, workers = 2), tweak(multisession, workers = 5)))
2. multisession:
   - args: function (..., workers = 5, envir = parent.frame())
   - tweaked: TRUE
   - call: plan(list(tweak(multisession, workers = 2), tweak(multisession, workers = 5)))</code></pre>
</div>
</div>
<p>Let’s check an outer loop with 1, and inner with 10, and vice versa</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-29_c2004528763fa32ca4722946fcae50ca">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>test1_10_double <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">1</span>, </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">10</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>test10_1_double <span class="ot">&lt;-</span> <span class="fu">outer_par</span>(<span class="at">outer_size =</span> <span class="dv">10</span>, </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">innerfun =</span> inner_par, <span class="at">inner_size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-30_f1e06ee44439317d5d7606d2aa76a89e">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>plot1_10_double <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test1_10_double, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>plot10_1_double <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test10_1_double, <span class="fu">aes</span>(<span class="at">x =</span> outer_iteration, </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">as.factor</span>(pid), </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> inner_iteration)) <span class="sc">+</span> </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>))</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>plot1_10_double <span class="sc">+</span> plot10_1_double</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="interrogating_parallel_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That worked! So, if we <em>explicitly</em> give each plan workers, we can manage nestedness.</p>
<p>Turn the plan back to multisession</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-31_9e13dd9c9070b92b45c8433da4c13f75">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">"list"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of future strategies:
1. multisession:
   - args: function (..., workers = availableCores(), lazy = FALSE, rscript_libs = .libPaths(), envir = parent.frame())
   - tweaked: FALSE
   - call: plan(multisession)</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<ul>
<li><p>Nesting parallel loops removes the parallelisation from the inner loop unless it’s done directly with <code>%:%</code> or with explicitly-declared list-plans.</p>
<ul>
<li>This means no intermediate processing without explicit worker-control</li>
</ul></li>
<li><p>Maybe this is OK- the <a href="../parallelism/nested_parallel.html">outer layer of parallelisation tends to work best</a> since it reduces the overhead:processing ratio.</p>
<ul>
<li>And the situation where nesting makes the most sense (nodes with cores) lend themselves to list-plans with <code>future.batchtools</code> and worker control internally. I think.</li>
</ul></li>
<li><p>BUT, need to be careful- we could be wasting workers if we parallelise over an outer layer with fewer jobs than workers- those ‘extra’ workers won’t be used by inner parallel loops</p>
<ul>
<li>above, where I had outer_size = 10, I got 10 PIDs, even though I have 20 cores available.</li>
</ul></li>
<li><p>It’s unclear how this works with more complex situations (e.g.&nbsp;on an HPC with nodes and workers)-</p>
<ul>
<li>will the outer layer grab nodes and inner layer workers? Or do we need to manually manage that by using job arrays? I think the answer is list-plans and treating the loop over <code>batchtools</code> as essentially an array-job, just managed by R not slurm. But that needs to be tested.</li>
</ul></li>
<li><p>I guess the good thing is the internal <code>foreach</code> isn’t hurting anything, except that a well-written <code>for</code> <a href="../parallelism/parallel_speed.html">would be faster</a>.</p>
<ul>
<li><p>So where we have control of things, need to test with and without <code>foreach</code>es in deep functions.</p></li>
<li><p>It would sure be nice if deep parallel foreaches that are getting their parallelisation skipped worked as fast as <code>for</code>, or even as fast as a sequential <code>foreach %do%</code></p></li>
</ul></li>
</ul>
</section>
<section id="interpreting-the-nested-speed-results" class="level1">
<h1>Interpreting the nested speed results</h1>
<p>In my <a href="../parallelism/nested_parallel.html">testing of speed of nested functions</a>, parallelising the inner loop was always slow. That can’t <em>always</em> be because the parallelisation is getting skipped- it would happen when the outer loop was sequential- but it suggests that the parallelisation is actually making things worse, <em>even when it gets skipped</em>.</p>
<p>As a test, we can combine the return values I use here with those functions to do the same processing but return the pids instead of the values to confirm when those inner loops actually get run in parallel.</p>
</section>
<section id="functions" class="level1">
<h1>Functions</h1>
<p>These do the same processing as in <a href="../parallelism/nested_parallel.html">my tests of nested speed</a>, but return a tibble of pids instead.</p>
<section id="inner-loop" class="level2">
<h2 class="anchored" data-anchor-id="inner-loop">Inner loop</h2>
<section id="parallel-version" class="level3">
<h3 class="anchored" data-anchor-id="parallel-version">Parallel version</h3>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-32_094016abaf108ed7bd85f43ff29f60ea">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>inner_par <span class="ot">&lt;-</span> <span class="cf">function</span>(in_vec, size, outer_it) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  inner_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">j =</span> in_vec,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%dorng%</span> {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> j)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size<span class="sc">*</span>size), <span class="at">nrow =</span> size)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> d <span class="sc">%*%</span> f</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    h <span class="ot">&lt;-</span> <span class="fu">mean</span>(g)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    thisproc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">"inner"</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">outer_iteration =</span> outer_it,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">inner_iteration =</span> j, </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(inner_out)</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sequential-version" class="level3">
<h3 class="anchored" data-anchor-id="sequential-version">Sequential version</h3>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-33_76334fb6ded4f25c7a1d4ae572eb2e74">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>inner_seq <span class="ot">&lt;-</span> <span class="cf">function</span>(in_vec, size, outer_it) {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  inner_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">j =</span> in_vec,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%do%</span> {</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> j)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size<span class="sc">*</span>size), <span class="at">nrow =</span> size)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> d <span class="sc">%*%</span> f</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    h <span class="ot">&lt;-</span> <span class="fu">mean</span>(g)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    thisproc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">"inner"</span>,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">outer_iteration =</span> outer_it,</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">inner_iteration =</span> j, </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(inner_out)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="using-preallocated-for" class="level3">
<h3 class="anchored" data-anchor-id="using-preallocated-for">Using preallocated for</h3>
<p>This is likely to be faster than the sequential. Preallocate both the vector <em>and</em> the new tibble output.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-34_31abcc4bee51f706f8021c4d9757a880">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>inner_for <span class="ot">&lt;-</span> <span class="cf">function</span>(in_vec, size, outer_it) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  inner_out <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">'numeric'</span>, <span class="at">length =</span> size)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  thisproc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">"inner"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">outer_iteration =</span> outer_it,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">inner_iteration =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(in_vec), </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pid =</span> <span class="fu">Sys.getpid</span>())</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(in_vec)) {</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> in_vec[j])</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size<span class="sc">*</span>size), <span class="at">nrow =</span> size)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> d <span class="sc">%*%</span> f</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    inner_out[j] <span class="ot">&lt;-</span> <span class="fu">mean</span>(g)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    thisproc<span class="sc">$</span>pid[j] <span class="ot">&lt;-</span> <span class="fu">Sys.getpid</span>()</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    thisproc<span class="sc">$</span>inner_iteration[j] <span class="ot">&lt;-</span> j</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(thisproc)</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="outer-loop" class="level2">
<h2 class="anchored" data-anchor-id="outer-loop">Outer loop</h2>
<p>I cant divide by inner_out now that it’s not a matrix, so just get a cv.</p>
<section id="parallel" class="level3">
<h3 class="anchored" data-anchor-id="parallel">parallel</h3>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-35_dbba80b015873c708f944fa5d45fbdac">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>outer_par <span class="ot">&lt;-</span> <span class="cf">function</span>(size, innerfun) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>size,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%dorng%</span> {</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Do a matrix mult on a vector specified with i</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>                         a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                         b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size<span class="sc">*</span>size), <span class="at">nrow =</span> size)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>                         cvec <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Now iterate over the values in c to do somethign else</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>                         inner_out <span class="ot">&lt;-</span> <span class="fu">innerfun</span>(<span class="at">in_vec =</span> cvec, </span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">size =</span> size, </span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">outer_it =</span> i)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>                         h <span class="ot">&lt;-</span> <span class="fu">sd</span>(cvec)<span class="sc">/</span><span class="fu">mean</span>(cvec)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>                         inner_out</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(outer_out)</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sequential" class="level3">
<h3 class="anchored" data-anchor-id="sequential">sequential</h3>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-36_805fc37b7c5ca61435bc7e8d908e8adf">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>outer_seq <span class="ot">&lt;-</span> <span class="cf">function</span>(size, innerfun) {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>size,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.combine =</span> bind_rows) <span class="sc">%do%</span> {</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Do a matrix mult on a vector specified with i</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>                         a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>                         b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size<span class="sc">*</span>size), <span class="at">nrow =</span> size)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>                         cvec <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># Now iterate over the values in c to do somethign else</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>                         inner_out <span class="ot">&lt;-</span> <span class="fu">innerfun</span>(<span class="at">in_vec =</span> cvec, </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">size =</span> size, <span class="at">outer_it =</span> i)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                         h <span class="ot">&lt;-</span> <span class="fu">sd</span>(cvec)<span class="sc">/</span><span class="fu">mean</span>(cvec)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>                         inner_out</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(outer_out)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="un-preallocated-for" class="level3">
<h3 class="anchored" data-anchor-id="un-preallocated-for">Un-preallocated for</h3>
<p>Because this would need to replace chnks in the tibble, it’s hard to preallocate. Just don’t bother- the point isn’t speed, it’s testing pids.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-37_6cffb64e643fe6c2d93e5edd8669ca33">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>outer_for <span class="ot">&lt;-</span> <span class="cf">function</span>(size, innerfun) {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> size, <span class="at">ncol =</span> size)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  thisproc <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">loop =</span> <span class="st">"inner"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">outer_iteration =</span> <span class="dv">1</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">inner_iteration =</span> <span class="dv">1</span>, </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pid =</span> <span class="fu">Sys.getpid</span>(),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.rows =</span> <span class="dv">0</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>size) {</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do a matrix mult on a vector specified with i</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, <span class="at">mean =</span> i)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(size<span class="sc">*</span>size), <span class="at">nrow =</span> size)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    cvec <span class="ot">&lt;-</span> a <span class="sc">%*%</span> b</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now iterate over the values in c to do somethign else</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    inner_out <span class="ot">&lt;-</span> <span class="fu">innerfun</span>(<span class="at">in_vec =</span> cvec, <span class="at">size =</span> size, <span class="at">outer_it =</span> i)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    outer_out[, i] <span class="ot">&lt;-</span> <span class="fu">sd</span>(cvec)<span class="sc">/</span><span class="fu">mean</span>(cvec)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    thisproc <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(thisproc, inner_out)</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>  outer_out <span class="ot">&lt;-</span> <span class="fu">c</span>(outer_out) </span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(thisproc)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="checking-pids" class="level1">
<h1>Checking PIDs</h1>
<p>I’m less interested here in benchmarks, and more in how the PIDs get used.</p>
<div class="cell" data-hash="interrogating_parallel_cache/html/unnamed-chunk-38_0734a56c70c7c95a1a00ef300d103cd7">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>benchsize <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>bench10 <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_par_in_par =</span> <span class="fu">outer_par</span>(benchsize, inner_par),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_par_in_seq =</span> <span class="fu">outer_par</span>(benchsize, inner_seq),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_par_in_for =</span> <span class="fu">outer_par</span>(benchsize, inner_for),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_seq_in_par =</span> <span class="fu">outer_seq</span>(benchsize, inner_par),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_seq_in_seq =</span> <span class="fu">outer_seq</span>(benchsize, inner_seq),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_seq_in_for =</span> <span class="fu">outer_seq</span>(benchsize, inner_for),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_for_in_par =</span> <span class="fu">outer_for</span>(benchsize, inner_par),</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_for_in_seq =</span> <span class="fu">outer_for</span>(benchsize, inner_seq),</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_for_in_for =</span> <span class="fu">outer_for</span>(benchsize, inner_for),</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>bench10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
           expr      min       lq      mean    median       uq       max neval
 out_par_in_par 106.5172 108.6633 140.19130 112.97430 126.6697  330.0178    10
 out_par_in_seq  88.0121  91.1837  93.73438  92.35530  96.8876   99.6031    10
 out_par_in_for  71.9364  73.8078 174.41494  76.24650  77.1631 1066.0401    10
 out_seq_in_par 666.4809 693.1190 695.28384 696.43735 705.4200  710.3611    10
 out_seq_in_seq 114.5846 117.2607 119.30622 119.86160 121.1580  124.2035    10
 out_seq_in_for  17.4582  18.0195  20.23517  19.41475  21.8744   26.9593    10
 out_for_in_par 670.6850 677.1433 691.50063 680.86140 697.3492  750.3875    10
 out_for_in_seq 112.9127 113.3315 116.69396 114.75315 118.5765  128.1516    10
 out_for_in_for  13.3640  13.9583  15.04485  14.88025  16.2860   16.6845    10</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>